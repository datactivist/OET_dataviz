---
title: "Progress of the MapYourGrid project"
format: 
  dashboard:
    nav-buttons:
      - icon: house-door-fill
        href: https://mapyourgrid.org/
        target: "_blank"
      - icon: github
        href: https://github.com/datactivist/OET_dataviz
        target: "_blank"
    include-in-header:
      - header.html
logo: "images/MapYourGrid-logo.png"
theme: [sandstone, custom.scss]
fig-width: 10
fig-asp: 0.3
server: shiny
resources: 
  - "leaflet.providers"
options:
  repos:
    CRAN: "https://cloud.r-project.org"
metadata:
  github: false
---

```{r}
#| label: chargement des packages et thème graphs
#| context: setup
#| message: false

library(tidyverse, warn.conflicts = FALSE)
library(plotly, warn.conflicts = FALSE)
library(scales, warn.conflicts = FALSE)
library(gt)
library(gtExtras)
library(janitor, warn.conflicts = FALSE)
library(sf)
library(leaflet)
library(leafem)
library(leaflet.extras2)
library(shiny)
library(bslib, warn.conflicts = FALSE)
library(bsicons)

#Thème pour les graphiques
theme_custom <- function (){
    ggplot2::theme(plot.title = ggplot2::element_text(size = 14, color = "#222222"), 
        plot.subtitle = ggplot2::element_text(size = 18, face = "italic", margin = ggplot2::margin(0, 0, 9, 0)), 
        plot.caption = ggplot2::element_text(size = 18, margin = ggplot2::margin(9, 0, 9, 0)), 
        plot.title.position = "plot",
        plot.caption.position = "plot",
        legend.title = ggplot2::element_text( size = 18, color = "#222222"), 
        legend.position = "top", 
        legend.text.align = 0, 
        legend.background = ggplot2::element_blank(),
        legend.key = ggplot2::element_blank(),
        legend.text = ggplot2::element_text(size = 14,color = "#222222"), 
        axis.text = ggplot2::element_text(size = 12,color = "#222222"), 
        axis.text.x = ggplot2::element_text(margin = ggplot2::margin(5,b = 10)), 
        axis.title = ggplot2::element_text(size = 12,color = "#222222"),
        axis.ticks = ggplot2::element_blank(),
        axis.line = ggplot2::element_blank(), 
        panel.grid.minor = ggplot2::element_blank(),
        panel.grid.major.y = ggplot2::element_line(color = "#cbcbcb"),
        panel.grid.major.x = ggplot2::element_blank(), 
        panel.background = ggplot2::element_blank(),
        strip.background = ggplot2::element_rect(fill = "white"),
        strip.text = ggplot2::element_text(size = 22, hjust = 0, face = "bold"),
        text = element_text(family = "Open Sans"))
}
```

```{r}
#| label: import data world to get last update

df_line <- read_csv("/data/api/data_lines_all.csv", show_col_types = FALSE, col_select = c(x, Pays))
last_date <- df_line |> 
  arrange(x) |> 
  slice_tail(n = 1)
first_date <- df_line |> 
  arrange(x) |> 
  slice_head(n = 1)
```



# Counts


::: {.sidebar}


The data displayed on this dashboard are from **`r format(as.Date(first_date$x, format = "%Y-%m-%dT%H:%M:%S"),"%Y-%m-%d")`** to **`r format(as.Date(last_date$x, format = "%Y-%m-%dT%H:%M:%S"),"%Y-%m-%d %H:%M:%S")`**.

Transmission assets over **50 kV**.

------------------------------------------------------------------------


Select a country to view its indicators. By default, **global indicators** are shown.

```{r}
#| label: choix du pays counts

# Bouton de sélection du pays
selectInput('nom_pays', 'Country', unique(df_line$Pays), selected = "World (default)")
```

:::

## Column {width="25%"}

### Row

```{r}
#| label: draft
#| context: server

# Circuits
value_world_circuits <- reactive({
  read_csv("/data/api/data_circuits_all.csv", show_col_types = FALSE) |> 
    select(-c(length, amount)) |> 
    rename(length = labels.transmission.length,
           amount = labels.transmission.amount) |> #on prend désormais les comptes *transmission*
    filter(Pays == input$nom_pays)
})
value_world_circuits_last <- reactive({
  value_world_circuits() |> 
    arrange(x) |> 
    slice_tail(n = 1) |> 
    mutate(amount = format(as.integer(amount, 0), nsmall = 1, big.mark = ","))
})
value_world_circuits_24H <- reactive({
  value_world_circuits() |> 
    arrange(x) |> 
    slice_tail(n = 2) |> 
    mutate(growth_rate = round((amount - lag(amount)) / amount *100, 2),
           amount = format(as.integer(amount, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})
value_world_circuits_month1 <- reactive({
  value_world_circuits() |> 
    arrange(x) |> 
    filter(x == max(x) | 
             x == as.Date(paste0(format(max(x), "%Y-%m"), "-01"))) |> 
    mutate(growth_rate = round((amount - lag(amount)) / amount *100, 2),
           amount = format(as.integer(amount, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})
# Lines (segments)
value_world_lines <- reactive({
  read_csv("/data/api/data_lines_all.csv", show_col_types = FALSE) |> 
    select(-c(length, amount)) |> 
    rename(length = labels.transmission.length,
           amount = labels.transmission.amount) |> #on prend désormais les comptes *transmission*
    filter(Pays == input$nom_pays)
})
value_world_lines_last <- reactive({
  value_world_lines() |> 
    arrange(x) |> 
    slice_tail(n = 1) |> 
    mutate(amount = format(as.integer(amount, 0), nsmall = 1, big.mark = ","))
})
value_world_lines_24H <- reactive({
  value_world_lines() |> 
    arrange(x) |> 
    slice_tail(n = 2) |> 
    mutate(growth_rate = round((amount - lag(amount)) / amount *100, 2),
           amount = format(as.integer(amount, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})
value_world_lines_month1 <- reactive({
  value_world_lines() |> 
    arrange(x) |> 
    filter(x == max(x) | 
             x == as.Date(paste0(format(max(x), "%Y-%m"), "-01"))) |> 
    mutate(growth_rate = round((amount - lag(amount)) / amount *100, 2),
           amount = format(as.integer(amount, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})
# Substations (posts)
value_world_substations <- reactive({
  read_csv("/data/api/data_substations_all.csv", show_col_types = FALSE) |> 
    select(-amount) |> 
    rename(amount = labels.transmission.amount) |> #on prend désormais les comptes *transmission*
    filter(Pays == input$nom_pays)
})
value_world_substations_last <- reactive({
  value_world_substations() |> 
    arrange(x) |> 
    slice_tail(n = 1) |> 
    mutate(amount = format(as.integer(amount, 0), nsmall = 1, big.mark = ","))
})
value_world_substations_24H <- reactive({
  value_world_substations() |> 
    arrange(x) |> 
    slice_tail(n = 2) |> 
    mutate(growth_rate = round((amount - lag(amount)) / amount *100, 2),
           amount = format(as.integer(amount, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})
value_world_substations_month1 <- reactive({
  value_world_substations() |> 
    arrange(x) |> 
    filter(x == max(x) | 
             x == as.Date(paste0(format(max(x), "%Y-%m"), "-01"))) |> 
    mutate(growth_rate = round((amount - lag(amount)) / amount *100, 2),
           amount = format(as.integer(amount, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})
# Generators 
value_world_generators <- reactive({
  read_csv("/data/api/data_generators_all.csv", show_col_types = FALSE) |> 
    filter(Pays == input$nom_pays)
})
value_world_generators_last <- reactive({
  value_world_generators() |> 
    arrange(x) |> 
    slice_tail(n = 1) |> 
    mutate(amount = format(as.integer(amount, 0), nsmall = 1, big.mark = ","))
})
value_world_generators_24H <- reactive({
  value_world_generators() |> 
    arrange(x) |> 
    slice_tail(n = 2) |> 
    mutate(growth_rate = round((amount - lag(amount)) / amount *100, 2),
           amount = format(as.integer(amount, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})
value_world_generators_month1 <- reactive({
  value_world_generators() |> 
    arrange(x) |> 
    filter(x == max(x) | 
             x == as.Date(paste0(format(max(x), "%Y-%m"), "-01"))) |> 
    mutate(growth_rate = round((amount - lag(amount)) / amount *100, 2),
           amount = format(as.integer(amount, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})
# plants 
value_world_plants <- reactive({
  read_csv("/data/api/data_plants_all.csv", show_col_types = FALSE) |> 
    filter(Pays == input$nom_pays)
})
value_world_plants_last <- reactive({
  value_world_plants() |> 
    arrange(x) |> 
    slice_tail(n = 1) |> 
    mutate(amount = format(as.integer(amount, 0), nsmall = 1, big.mark = ","))
})
value_world_plants_24H <- reactive({
  value_world_plants() |> 
    arrange(x) |> 
    slice_tail(n = 2) |> 
    mutate(growth_rate = round((amount - lag(amount)) / amount *100, 2),
           amount = format(as.integer(amount, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})
value_world_plants_month1 <- reactive({
  value_world_plants() |> 
    arrange(x) |> 
    filter(x == max(x) | 
             x == as.Date(paste0(format(max(x), "%Y-%m"), "-01"))) |> 
    mutate(growth_rate = round((amount - lag(amount)) / amount *100, 2),
           amount = format(as.integer(amount, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})

# Fonction pour les plots dans les valuebox avec != éléments qd petit ou grand
plotly_time_series <- function(d, x, y, my_title) {
    info <- getCurrentOutputInfo()
    large <- isTRUE(info$height() > 200)
    
    plot_ly(d, x = x, y = y, hoverinfo = if (large) "x+y" else "skip") %>%
      add_lines(color = I(info$fg()), span = I(1),
                fill = 'tozeroy', alpha = 0.2) %>%
      layout(hovermode = "x",
             margin = list(t = if (large) 40 else 0, r = 0, l = 0, b = 0),
             font = list(color = info$fg()),
             paper_bgcolor = "transparent",
             plot_bgcolor = "transparent",
             title = if (large) {
              list(text = paste("<b>       ", my_title, "</b>",
                "<br><span style='font-size:14px; opacity:0.7; x=0;'>              OpenStreetMap amount of feature at each time considered on X axis</span>"), 
                   x = 0, xanchor = "left", font = list(size = 25))
             } else { NULL },
             xaxis = list(
              title = "Time",
              visible = large,
              showgrid = FALSE
             ),
             yaxis = list(
              title = "",
              visible = large,
              showgrid = FALSE#,
              #range = if (large) {c(0, max(y, na.rm = TRUE)+ 0.5*max(y, na.rm = TRUE))} 
              #  else { NULL } #pour avoir y avec marge au-dessus pour les titres
            )
      ) %>%
      config(displayModeBar = FALSE)
  }
```



```{r}
#| label: VB 2
value_box(
  id = "card2",
  title = "Number of segments",
  theme = value_box_theme(bg = "#f1d365", fg = "#4f4e4d"),
  value = uiOutput("n2_complete"),
  showcase = plotlyOutput("n2_sparkline")
)
```

### Row

```{r}
#| label: VB 1
value_box(
  id = "card1",
  title = "Number of circuits relations",
  theme = value_box_theme(bg = "#036d7a", fg = "white"),
  value = uiOutput("n1_complete"),
  showcase = plotlyOutput("n1_sparkline")
)
```

### Row

```{r}
#| label: VB 3
value_box(
  id = "card3",
  title = "Number of substations",
  theme = value_box_theme(bg = "#54a36a", fg = "white"),
  value = uiOutput("n3_complete"),
  showcase = plotlyOutput("n3_sparkline")
)
```

### Row

```{r}
#| label: VB 4
value_box(
  id = "card4",
  title = "Number of generators",
  theme = value_box_theme(bg = "#985750", fg = "white"),
  value = uiOutput("n4_complete"),
  showcase = plotlyOutput("n4_sparkline")
)
```


### Row

```{r}
#| label: VB 4.2
value_box(
  id = "card4.2",
  title = "Number of plants",
  theme = value_box_theme(bg = "#f19050", fg = "#4f4e4d"),
  value = uiOutput("n4.2_complete"),
  showcase = plotlyOutput("n4.2_sparkline")
)
```

```{r}
#| label: display 5 valuebox
#| context: server

output$n2_complete <- renderUI({

  if (value_world_lines_last()$amount == "NA") { #on n'affiche rien qd df vide (sinon error affichée)
    "-" } else {

  tags$div(tags$div(style = "font-size: 1.2em;",
                    ifelse(value_world_lines_last()$amount == "NA", "", value_world_lines_last()$amount)),
    tags$div(style = "font-size: 0.5em; margin-top: 12px; opacity: 0.9;",
             tags$div(tags$img(src = "images/myg_24h.svg",
                               style = "height: 25px; vertical-align: top; margin-right: 5px;"),
                      tags$span(style = "font-size: 1.5em;",value_world_lines_24H()$amount),
                      if(value_world_lines_last()$amount > value_world_lines_24H()$amount) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"),
                                paste0("+", value_world_lines_24H()$growth_rate, "%"))
                        } else if(value_world_lines_last()$amount < value_world_lines_24H()$amount) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(value_world_lines_24H()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #FFA500;", "=")
                          }),
             tags$div(style = "margin-top: 2px;",
                      tags$img(src = "images/myg_1m.svg",
                               style = "height: 25px; vertical-align: top; margin-right: 5px;"),
                      tags$span(style = "font-size: 1.5em;", value_world_lines_month1()$amount),
                      if(value_world_lines_last()$amount > value_world_lines_month1()$amount) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"),
                                paste0("+", value_world_lines_month1()$growth_rate, "%"))
                        } else if(value_world_lines_last()$amount < value_world_lines_month1()$amount) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(value_world_lines_month1()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #FFA500;", "=")
                          })))
    }
})
output$n2_sparkline <- renderPlotly({
  plotly_time_series(value_world_lines(),
                     x = ~x, y = ~amount,
                     my_title = input$nom_pays)
  })
output$n1_complete <- renderUI({
  
  if (nrow(value_world_circuits()) == 0) { #on n'affiche rien qd df vide (sinon error affichée)
    "-" } else {
      
  tags$div(tags$div(style = "font-size: 1.2em;", 
                    value_world_circuits_last()$amount),
    tags$div(style = "font-size: 0.5em; margin-top: 12px; opacity: 0.9;",
             tags$div(tags$img(src = "images/myg_24h.svg", 
                               style = "height: 25px; vertical-align: top; margin-right: 5px; filter: brightness(0) invert(1);"), 
                      tags$span(style = "font-size: 1.5em;", value_world_circuits_24H()$amount),
                      if(value_world_circuits_last()$amount > value_world_circuits_24H()$amount) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"), 
                                paste0("+", value_world_circuits_24H()$growth_rate, "%"))
                        } else if(value_world_circuits_last()$amount < value_world_circuits_24H()$amount) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(value_world_circuits_24H()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #f19050;", "=") 
                          }),
             tags$div(style = "margin-top: 2px;",
                      tags$img(src = "images/myg_1m.svg", 
                               style = "height: 25px; vertical-align: top; margin-right: 5px; filter: brightness(0) invert(1);"),
                      tags$span(style = "font-size: 1.5em;", value_world_circuits_month1()$amount),
                      if(value_world_circuits_last()$amount > value_world_circuits_month1()$amount) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"),
                                paste0("+", value_world_circuits_month1()$growth_rate, "%"))
                        } else if(value_world_circuits_last()$amount < value_world_circuits_month1()$amount) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(value_world_circuits_month1()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #f19050;", "=")
                          })))
    }
})
output$n1_sparkline <- renderPlotly({
  plotly_time_series(value_world_circuits(),
                     x = ~x, y = ~amount,
                     my_title = input$nom_pays)
  })
output$n3_complete <- renderUI({
  
  if (value_world_substations_last()$amount == "NA") { #on n'affiche rien qd df vide (sinon error affichée)
    "-" } else {
      
  tags$div(tags$div(style = "font-size: 1.2em;", 
                    ifelse(value_world_substations_last()$amount == "NA", "", value_world_substations_last()$amount)),
    tags$div(style = "font-size: 0.5em; margin-top: 12px; opacity: 0.9;",
             tags$div(tags$img(src = "images/myg_24h.svg", 
                               style = "height: 25px; vertical-align: top; margin-right: 5px; filter: brightness(0) invert(1);"), 
                      tags$span(style = "font-size: 1.5em;",value_world_substations_24H()$amount),
                      if(value_world_substations_last()$amount > value_world_substations_24H()$amount) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"), 
                                paste0("+", value_world_substations_24H()$growth_rate, "%"))
                        } else if(value_world_substations_last()$amount < value_world_substations_24H()$amount) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(value_world_substations_24H()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #FFA500;", "=") 
                          }),
             tags$div(style = "margin-top: 2px;",
                      tags$img(src = "images/myg_1m.svg", 
                               style = "height: 25px; vertical-align: top; margin-right: 5px; filter: brightness(0) invert(1);"), 
                      tags$span(style = "font-size: 1.5em;", value_world_substations_month1()$amount),
                      if(value_world_substations_last()$amount > value_world_substations_month1()$amount) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"),
                                paste0("+", value_world_substations_month1()$growth_rate, "%"))
                        } else if(value_world_substations_last()$amount < value_world_substations_month1()$amount) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(value_world_substations_month1()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #FFA500;", "=")
                          })))
    }
})
output$n3_sparkline <- renderPlotly({
  plotly_time_series(value_world_substations(),
                     x = ~x, y = ~amount,
                     my_title = input$nom_pays)
  })
output$n4_complete <- renderUI({
  
  if (value_world_generators_last()$amount == "NA") { #on n'affiche rien qd df vide (sinon error affichée)
    "-" } else {
      
  tags$div(tags$div(style = "font-size: 1.2em;", 
                    ifelse(value_world_generators_last()$amount == "NA", "", value_world_generators_last()$amount)),
    tags$div(style = "font-size: 0.5em; margin-top: 12px; opacity: 0.9;",
             tags$div(tags$img(src = "images/myg_24h.svg", 
                               style = "height: 25px; vertical-align: top; margin-right: 5px; filter: brightness(0) invert(1);"), 
                      tags$span(style = "font-size: 1.5em;", value_world_generators_24H()$amount),
                      if(value_world_generators_last()$amount > value_world_generators_24H()$amount) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"), 
                                paste0("+", value_world_generators_24H()$growth_rate, "%"))
                        } else if(value_world_generators_last()$amount < value_world_generators_24H()$amount) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(value_world_generators_24H()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #FFA500;", "=") 
                          }),
             tags$div(style = "margin-top: 2px;",
                      tags$img(src = "images/myg_1m.svg", 
                               style = "height: 25px; vertical-align: top; margin-right: 5px; filter: brightness(0) invert(1);"), 
                      tags$span(style = "font-size: 1.5em;", value_world_generators_month1()$amount),
                      if(value_world_generators_last()$amount > value_world_generators_month1()$amount) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"),
                                paste0("+", value_world_generators_month1()$growth_rate, "%"))
                        } else if(value_world_generators_last()$amount < value_world_generators_month1()$amount) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(value_world_generators_month1()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #FFA500;", "=")
                          })))
    }
})
output$n4_sparkline <- renderPlotly({
  plotly_time_series(value_world_generators(),
                     x = ~x, y = ~amount,
                     my_title = input$nom_pays)
  })
output$n4.2_complete <- renderUI({
  
  if (value_world_plants_last()$amount == "NA") { #on n'affiche rien qd df vide (sinon error affichée)
    "-" } else {
      
  tags$div(tags$div(style = "font-size: 1.2em;", 
                    ifelse(value_world_plants_last()$amount == "NA", "", value_world_plants_last()$amount)),
    tags$div(style = "font-size: 0.5em; margin-top: 12px; opacity: 0.9;",
             tags$div(tags$img(src = "images/myg_24h.svg", 
                               style = "height: 25px; vertical-align: top; margin-right: 5px;"), 
                      tags$span(style = "font-size: 1.5em;", value_world_plants_24H()$amount),
                      if(value_world_plants_last()$amount > value_world_plants_24H()$amount) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"), 
                                paste0("+", value_world_plants_24H()$growth_rate, "%"))
                        } else if(value_world_plants_last()$amount < value_world_plants_24H()$amount) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(value_world_plants_24H()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #f1d365;", "=") 
                          }),
             tags$div(style = "margin-top: 2px;",
                      tags$img(src = "images/myg_1m.svg", 
                               style = "height: 25px; vertical-align: top; margin-right: 5px;"), 
                      tags$span(style = "font-size: 1.5em;", value_world_plants_month1()$amount),
                      if(value_world_plants_last()$amount > value_world_plants_month1()$amount) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"),
                                paste0("+", value_world_plants_month1()$growth_rate, "%"))
                        } else if(value_world_plants_last()$amount < value_world_plants_month1()$amount) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(value_world_plants_month1()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #f1d365;", "=")
                          })))
    }
})
output$n4.2_sparkline <- renderPlotly({
  plotly_time_series(value_world_plants(),
                     x = ~x, y = ~amount,
                     my_title = input$nom_pays)
  })
```



## Column {width="80%"}

### Row


#### Column {width="60%"}

```{r}
#| context: server
#| label: prepare data evolution 100 graph

# Préparation des données
circuits_mars25 <- reactive({
  value_world_circuits() |> 
    filter(as.Date(x) == "2025-03-01")
})
line_mars25 <- reactive({
  value_world_lines() |> 
    filter(as.Date(x) == "2025-03-01")
})
substations_mars25 <- reactive({
  value_world_substations() |> 
    filter(as.Date(x) == "2025-03-01")
})
generators_mars25 <- reactive({
  value_world_generators() |> 
    filter(as.Date(x) == "2025-03-01")
})
plants_mars25 <- reactive({
  value_world_plants() |> 
    filter(as.Date(x) == "2025-03-01")
})


table <- reactive({
  left_join(value_world_lines() |> select(c(x, amount, Pays)) |> rename(nb_segments = amount), 
            value_world_substations() |> select(c(x, amount, Pays)) |> rename(nb_substations = amount), 
            by = "x") |> 
  left_join(value_world_generators() |> select(c(x, amount, Pays)) |> rename(nb_generators = amount),
            by = "x") |> 
  left_join(value_world_circuits() |> select(c(x, amount, Pays)) |> rename(nb_circuits = amount),
            by = "x") |> 
  left_join(value_world_plants() |> select(c(x, amount, Pays)) |> rename(nb_plants = amount),
            by = "x") |> 
  arrange(x) |> 
  #transformation des métriques en base 100 en mars 2025
  mutate(nb_segments_100_mars25 = ifelse(is.na(nb_segments), NA_real_, nb_segments / line_mars25()$amount * 100), #amount
         nb_segments_100_diff = ifelse(is.na(nb_segments), NA_real_, round(nb_segments_100_mars25 - 100, 1)),
         nb_segments_diff = ifelse(is.na(nb_segments), NA_real_, round(nb_segments - line_mars25()$amount, 0)), #amount
         nb_circuits_100_mars25 = ifelse(is.na(nb_circuits), NA_real_, nb_circuits / circuits_mars25()$amount * 100),
         nb_circuits_100_diff = ifelse(is.na(nb_circuits), NA_real_, round(nb_circuits_100_mars25 - 100, 1)),
         nb_circuits_diff = ifelse(is.na(nb_circuits), NA_real_, nb_circuits - circuits_mars25()$amount),
         nb_substations_100_mars25 = ifelse(is.na(nb_substations), NA_real_, nb_substations / substations_mars25()$amount * 100),
         nb_substations_100_diff = ifelse(is.na(nb_substations), NA_real_, round(nb_substations_100_mars25 - 100, 1)),
         nb_substations_diff = ifelse(is.na(nb_substations), NA_real_, nb_substations - substations_mars25()$amount),
         nb_generators_100_mars25 = ifelse(is.na(nb_generators), NA_real_, nb_generators / generators_mars25()$amount * 100),
         nb_generators_100_diff = ifelse(is.na(nb_generators), NA_real_, round(nb_generators_100_mars25 - 100, 1)),
         nb_generators_diff = ifelse(is.na(nb_generators), NA_real_, nb_generators - generators_mars25()$amount),
         nb_plants_100_mars25 = ifelse(is.na(nb_plants), NA_real_, nb_plants / plants_mars25()$amount * 100),
         nb_plants_100_diff = ifelse(is.na(nb_plants), NA_real_, round(nb_plants_100_mars25 - 100, 1)),
         nb_plants_diff = ifelse(is.na(nb_plants), NA_real_, nb_plants - plants_mars25()$amount))
})
  #calcul de la valeur minimale en base 100 (pour placer geom_rect)
min_mesures <- reactive({
  c(ifelse(is.na(table()$nb_segments), NA_real_, min(table()$nb_segments_100_mars25, na.rm = TRUE)),
    ifelse(is.na(table()$nb_circuits), NA_real_, min(table()$nb_circuits_100_mars25, na.rm = TRUE)),
    ifelse(is.na(table()$nb_substations), NA_real_, min(table()$nb_substations_100_mars25, na.rm = TRUE)),
    ifelse(is.na(table()$nb_generators), NA_real_, min(table()$nb_generators_100_mars25, na.rm = TRUE)),
    ifelse(is.na(table()$nb_plants), NA_real_, min(table()$nb_plants_100_mars25, na.rm = TRUE)))
})
min_min_100 <- reactive({
  min(min_mesures(), na.rm = TRUE)
})
  #calcul de la valeur maximale en base 100 (pour placer geom_rect)
max_mesures <- reactive({
  c(ifelse(is.na(table()$nb_segments), NA_real_, max(table()$nb_segments_100_mars25, na.rm = TRUE)),
    ifelse(is.na(table()$nb_circuits), NA_real_, max(table()$nb_circuits_100_mars25, na.rm = TRUE)),
    ifelse(is.na(table()$nb_substations), NA_real_, max(table()$nb_substations_100_mars25, na.rm = TRUE)),
    ifelse(is.na(table()$nb_generators), NA_real_, max(table()$nb_generators_100_mars25, na.rm = TRUE)),
    ifelse(is.na(table()$nb_plants), NA_real_, max(table()$nb_plants_100_mars25, na.rm = TRUE)))
})
max_max_100 <- reactive({
  max(max_mesures(), na.rm = TRUE)
})
```


```{r}
#| title: Evolutions base 100 in March 2025
plotlyOutput('plot5')
```

```{r}
#| context: server
#| label: graph base 100

# Plot
output$plot5 <- renderPlotly({

      if (nrow(table()) == 0) {
    # Créer un plotly vide avec message
    plot_ly() |>
      layout(
        xaxis = list(showgrid = FALSE, showticklabels = FALSE, zeroline = FALSE),
        yaxis = list(showgrid = FALSE, showticklabels = FALSE, zeroline = FALSE),
        annotations = list(
          list(
            text = "No data for this country",
            xref = "paper",
            yref = "paper",
            x = 0.5,
            y = 0.5,
            showarrow = FALSE,
            font = list(size = 16, color = "gray")
          )
        )
      )
  } else {
    
  #plot depending on selected country
  graph <- table() |> 
    mutate(x = as.Date(x)) |> 
    ggplot() +
    #distinction des périodes du projet
    # geom_rect(aes(xmin = as.Date("2024-11-01"), xmax = as.Date("2025-03-01"),
    #               ymin = min_min_100(), ymax = max_max_100(),
    #               text = "Early OET"), fill = "#333333", alpha = 0.2) +
    # geom_rect(aes(xmin = as.Date("2025-03-01"), xmax = as.Date("2025-08-01"),
    #               ymin = min_min_100(), ymax = max_max_100(),
    #               text = "Kickoff"), fill = "#a2a2a3", alpha = 0.2) +
    # geom_rect(aes(xmin = as.Date("2025-08-01"), xmax = max(x),
    #               ymin = min_min_100(), ymax = max_max_100(),
    #               text = "Public launch"), fill = "#656566", alpha = 0.2) +
    #ligne colorée jusqu'à 100 pour nb of segments
    geom_line(aes(x = x, y = nb_segments_100_mars25, group = 1, 
                  text = case_when(nb_segments_100_diff < 0 ~ paste0("Time : ", x, "\n↓ ", abs(nb_segments_100_diff), 
                                                                "% (", format(as.integer(nb_segments_diff, 0), nsmall = 1, big.mark = ","), " segments)"),
                                   nb_segments_100_diff == 0 ~ "Base 100",
                                   .default = paste0("Time : ", x, "\n↑ ", abs(nb_segments_100_diff), 
                                                                "% (+", format(as.integer(nb_segments_diff, 0), nsmall = 1, big.mark = ","), " segments)")),
                  color = "Segments"), linewidth = .7) +
    #ligne colorée jusqu'à 100 pour nb of circuits
    geom_line(aes(x = x, y = nb_circuits_100_mars25,group = 1,
                  text = case_when(nb_circuits_100_diff < 0 ~ paste0("Time : ", x, "\n↓ ", abs(nb_circuits_100_diff), 
                                                                "% (", format(as.integer(nb_circuits_diff, 0), nsmall = 1, big.mark = ","), " circuits relations)"),
                                   nb_circuits_100_diff == 0 ~ "Base 100",
                                   .default = paste0("Time : ", x, "\n↑ ", abs(nb_circuits_100_diff), 
                                                                "% (+", format(as.integer(nb_circuits_diff, 0), nsmall = 1, big.mark = ","), " circuits relations)")),
                  color = "Circuits \nrelations"), linewidth = .7) +
    #ligne colorée jusqu'à 100 pour nb of substations
    geom_line(aes(x = x, y = nb_substations_100_mars25, group = 1, 
                  text = case_when(nb_substations_100_diff < 0 ~ paste0("Time : ", x, "\n↓ ", abs(nb_substations_100_diff), 
                                                                "% (", format(as.integer(nb_substations_diff, 0), nsmall = 1, big.mark = ","), " substations)"),
                                   nb_substations_100_diff == 0 ~ "Base 100",
                                   .default = paste0("Time : ", x, "\n↑ ", abs(nb_substations_100_diff), 
                                                                "% (+", format(as.integer(nb_substations_diff, 0), nsmall = 1, big.mark = ","), " substations)")),
                  color = "Substations"), linewidth = .7) +
    #ligne colorée jusqu'à 100 pour nb of generators
    geom_line(aes(x = x, y = nb_generators_100_mars25, group = 1, 
                  text = case_when(nb_generators_100_diff < 0 ~ paste0("Time : ", x, "\n↓ ", abs(nb_generators_100_diff), 
                                                                "% (", format(as.integer(nb_generators_diff, 0), nsmall = 1, big.mark = ","), " generators)"),
                                   nb_generators_100_diff == 0 ~ "Base 100",
                                   .default = paste0("Time : ", x, "\n↑ ", abs(nb_generators_100_diff), 
                                                                "% (+", format(as.integer(nb_generators_diff, 0), nsmall = 1, big.mark = ","), " generators)")),
                  color = "Generators"), linewidth = .7) +
    #ligne colorée jusqu'à 100 pour nb of plants
    geom_line(aes(x = x, y = nb_plants_100_mars25, group = 1, 
                  text = case_when(nb_plants_100_diff < 0 ~ paste0("Time : ", x, "\n↓ ", abs(nb_plants_100_diff), 
                                                                "% (", format(as.integer(nb_plants_diff, 0), nsmall = 1, big.mark = ","), " plants)"),
                                   nb_plants_100_diff == 0 ~ "Base 100",
                                   .default = paste0("Time : ", x, "\n↑ ", abs(nb_plants_100_diff), 
                                                                "% (+", format(as.integer(nb_plants_diff, 0), nsmall = 1, big.mark = ","), " plants)")),
                  color = "Plants"), linewidth = .7) +
    #ligne pointillée au 1er mars 2025
    #geom_vline(xintercept = as.Date("2025-03-01"), linetype = 2, color = "red4") +
    #mises en forme générales
    scale_x_date(date_labels = "%m-%y", breaks = pretty_breaks(n = 7)) +
    scale_y_continuous(labels = scales::comma) +
    scale_color_manual(values = c("Segments" = "#ecc123", 
                                  "Circuits \nrelations" = "#036d7a",
                                  "Substations" = "#54a36a",
                                  "Generators" = "#6d0f06",
                                  "Plants" = "#f19050")) +
    labs(x = "Time", 
         y = "Base 100 in 03-2025", 
         color = "") + 
    theme_custom() +
    theme(axis.ticks.x = element_line(color = "#cbcbcb"),
          legend.position = "top",
          panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
          panel.grid.minor.x = ggplot2::element_line(color = "#cbcbcb")) +
    guides(color = guide_legend(nrow = 2))
  #interactive graph
  ggplotly(graph, tooltip = c("text")) |> 
    layout(yaxis = list(autorange = TRUE),
           showlegend = TRUE,  # Légende affichée par défaut
           updatemenus = list(list(type = "buttons", direction = "left", 
                                   xanchor = "center", yanchor = "top", x = 0.5, y = 1.15,
                                   buttons = list(list(method = "relayout", 
                                                       args = list("showlegend", TRUE), 
                                                       label = "Show legend"),
                                                  list(method = "relayout", 
                                                       args = list("showlegend", FALSE),
                                                       label = "Hide legend")))))
  }
})
```


#### Column {width="35%"}



```{r}
#| context: server
#| label: prepare data growth rate graph

# Préparation des données
    #circuits
circuits_counts1 <- reactive({
  value_world_circuits() |> 
    mutate(x = as.Date(x)) |> 
    filter(x == "2025-03-01" | x == max(x, na.rm = TRUE)) |> 
    mutate(growth_rate_circuits = (amount - lag(amount)) / lag(amount)) |> 
    select(growth_rate_circuits) |> 
    na.omit()
})
    #lines
lines_counts1 <- reactive({
  value_world_lines() |> 
    mutate(x = as.Date(x)) |> 
    filter(x == "2025-03-01" | x == max(x, na.rm = TRUE)) |> 
    mutate(growth_rate_segments = (amount - lag(amount)) / lag(amount)) |> 
    select(growth_rate_segments) |> 
    na.omit()
})
    #substations
substations_counts1 <- reactive({
  value_world_substations() |> 
    mutate(x = as.Date(x)) |> 
    filter(x == "2025-03-01" | x == max(x, na.rm = TRUE)) |> 
    mutate(growth_rate_substations = (amount - lag(amount)) / lag(amount)) |> 
    select(growth_rate_substations) |> 
    na.omit()
})
    # generators
generators_counts1 <- reactive({
  value_world_generators() |> 
    mutate(x = as.Date(x)) |> 
    filter(x == "2025-03-01" | x == max(x, na.rm = TRUE)) |> 
    mutate(growth_rate_generators = (amount - lag(amount)) / lag(amount)) |> 
    select(growth_rate_generators) |> 
    na.omit()
}) 
    # plants
plants_counts1 <- reactive({
  value_world_plants() |> 
    mutate(x = as.Date(x)) |> 
    filter(x == "2025-03-01" | x == max(x, na.rm = TRUE)) |> 
    mutate(growth_rate_plants = (amount - lag(amount)) / lag(amount)) |> 
    select(growth_rate_plants) |> 
    na.omit()
}) 

dfs_list_counts <- reactive({
  list(lines_counts1(), circuits_counts1(), substations_counts1(), generators_counts1(), plants_counts1())
})
dfs_non_vides_counts <- reactive({
  Filter(function(x) nrow(x) > 0, dfs_list_counts())
})

growth_rate <- reactive({
  bind_cols(dfs_non_vides_counts()) |> 
    pivot_longer(cols = everything(), values_to = "Valeur", names_to = "Mesure", names_prefix = "growth_rate_") |> 
    mutate(Mesure = gsub("^([[:alpha:]])(.*)$", "\\U\\1\\L\\2", Mesure, perl = TRUE)) |> 
    mutate(Mesure = str_replace(Mesure, "Circuits", "Circuits relations"))
})
```

```{r}
#| title: Growth rate since March 2025
plotlyOutput('plot6')
```

```{r}
#| context: server
#| label: graph growth rate counts

# Plot line length
output$plot6 <- renderPlotly({
  
  if (nrow(growth_rate()) == 0) {
    # Créer un plotly vide avec message
    plot_ly() |>
      layout(
        xaxis = list(showgrid = FALSE, showticklabels = FALSE, zeroline = FALSE),
        yaxis = list(showgrid = FALSE, showticklabels = FALSE, zeroline = FALSE),
        annotations = list(
          list(
            text = "No data for this country",
            xref = "paper",
            yref = "paper",
            x = 0.5,
            y = 0.5,
            showarrow = FALSE,
            font = list(size = 16, color = "gray")
          )
        )
      )
  } else {

  #plot depending on selected country
  graph <- growth_rate() |> 
    mutate(Mesure = factor(Mesure, levels = c("Plants", "Generators", "Substations", "Circuits relations", "Segments"))) |> 
    ggplot() +
    geom_segment(aes(x = 0, xend = Valeur, y = Mesure, yend = Mesure, color = Mesure), linewidth = 1) +
    geom_point(aes(x = Valeur, y = Mesure, color = Mesure,
                   text = paste("+", round(Valeur*100, 2), "%")), size = 4) +
    labs(y = "", x = "Growth rate (%)") +
    scale_color_manual(values = c("Segments" = "#ecc123",
                                  "Circuits relations" = "#036d7a",
                                  "Substations" = "#54a36a",
                                  "Generators" = "#6d0f06",
                                  "Plants" = "#f19050")) +
    scale_x_continuous(labels = scales::percent) +
    scale_y_discrete(labels = function(x) stringr::str_wrap(x, width = 10)) + #axis-text trop longs sur plusieurs lignes
    theme_custom() +
    theme(legend.position = "none", 
          panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
          panel.grid.major.y = ggplot2::element_blank()) 
  #interactive graph
  ggplotly(graph, tooltip = c("text")) |> 
    layout(xaxis = list(tickmode = "auto", tickformat = ".0%"))
  }
})
```



# Length


::: {.sidebar}


The data displayed on this dashboard are from **`r format(as.Date(first_date$x, format = "%Y-%m-%dT%H:%M:%S"),"%Y-%m-%d")`** to **`r format(as.Date(last_date$x, format = "%Y-%m-%dT%H:%M:%S"),"%Y-%m-%d %H:%M:%S")`**.

Transmission assets over **50 kV**.

------------------------------------------------------------------------


Select a country to view its indicators. By default, **global indicators** are shown.

```{r}
#| label: choix du pays length

# Bouton de sélection du pays
selectInput('nom_pays_length', 'Country', unique(df_line$Pays), selected = "World (default)")
```

:::

## Column {width="25%"}

### Row


```{r}
#| context: server
#| label: get data length

# Circuits
value_world_circuits_length <- reactive({
  read_csv("/data/api/data_circuits_all.csv", show_col_types = FALSE) |> 
    select(-c(length, amount)) |> 
    rename(length = labels.transmission.length,
           amount = labels.transmission.amount) |> #on prend désormais les comptes *transmission*
    mutate(length = length / 1000) |> 
    filter(Pays == input$nom_pays_length)
})
value_world_circuits_last_length <- reactive({
  value_world_circuits_length() |> 
    arrange(x) |> 
    slice_tail(n = 1) |> 
    mutate(length = format(as.integer(length, 0), nsmall = 1, big.mark = ","),
           amount = format(as.integer(amount, 0), nsmall = 1, big.mark = ",")) |> 
    select(length) |> 
    na.omit()
})
value_world_circuits_24H_length <- reactive({
  value_world_circuits_length() |> 
    arrange(x) |> 
    slice_tail(n = 2) |> 
    mutate(growth_rate = round((length - lag(length)) / length *100, 2),
           length = format(as.integer(length, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})
value_world_circuits_month1_length <- reactive({
  value_world_circuits_length() |> 
    arrange(x) |> 
    filter(x == max(x) | 
             x == as.Date(paste0(format(max(x), "%Y-%m"), "-01"))) |> 
    mutate(growth_rate = round((length - lag(length)) / length *100, 2),
           length = format(as.integer(length, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})
# Lines (segments)
value_world_lines_length <- reactive({
  read_csv("/data/api/data_lines_all.csv", show_col_types = FALSE) |> 
    select(-c(length, amount)) |> 
    rename(length = labels.transmission.length,
           amount = labels.transmission.amount) |> #on prend désormais les comptes *transmission*
    filter(Pays == input$nom_pays_length)
})
value_world_lines_last_length <- reactive({
  value_world_lines_length() |> 
    arrange(x) |> 
    slice_tail(n = 1) |> 
    mutate(length = format(as.integer(length, 0), nsmall = 1, big.mark = ","),
           amount = format(as.integer(amount, 0), nsmall = 1, big.mark = ",")) |> 
    select(length) |> 
    na.omit()
})
value_world_lines_24H_length <- reactive({
  value_world_lines_length() |> 
    arrange(x) |> 
    slice_tail(n = 2) |> 
    mutate(growth_rate = round((length - lag(length)) / length *100, 2),
           length = format(as.integer(length, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})
value_world_lines_month1_length <- reactive({
  value_world_lines_length() |> 
    arrange(x) |> 
    filter(x == max(x) | 
             x == as.Date(paste0(format(max(x), "%Y-%m"), "-01"))) |> 
    mutate(growth_rate = round((length - lag(length)) / length *100, 2),
           length = format(as.integer(length, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})
# Substations (posts)
value_world_substations_length <- reactive({
  read_csv("/data/api/data_substations_all.csv", show_col_types = FALSE) |> 
    select(-c(amount, area)) |> 
    rename(area = labels.transmission.area,
           amount = labels.transmission.amount) |> #on prend désormais les comptes *transmission*
    mutate(area = area/100000) |> #m² à km²
    filter(Pays == input$nom_pays_length)
})
value_world_substations_last_length <- reactive({
  value_world_substations_length() |> 
    arrange(x) |> 
    slice_tail(n = 1) |> 
    mutate(amount = format(as.integer(amount, 0), nsmall = 1, big.mark = ","),
           area = format(as.integer(area, 0), nsmall = 1, big.mark = ",")) |> 
    select(area) |> 
    na.omit()
})
value_world_substations_24H_length <- reactive({
  value_world_substations_length() |> 
    arrange(x) |> 
    slice_tail(n = 2) |> 
    mutate(growth_rate = round((area - lag(area)) / area *100, 2),
           area = format(as.integer(area, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})
value_world_substations_month1_length <- reactive({
  value_world_substations_length() |> 
    arrange(x) |> 
    filter(x == max(x) | 
             x == as.Date(paste0(format(max(x), "%Y-%m"), "-01"))) |> 
    mutate(growth_rate = round((area - lag(area)) / area *100, 2),
           area = format(as.integer(area, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})
```



```{r}
#| label: VB 2length
value_box(
  id = "card2",
  title = "Line length (km)",
  theme = value_box_theme(bg = "#f1d365", fg = "#4f4e4d"),
  value = uiOutput("n2_complete_length"),
  showcase = plotlyOutput("n2_sparkline_length")
)
```

### Row

```{r}
#| label: VB 1length
value_box(
  id = "card1",
  title = "Circuits relations length (km)",
  theme = value_box_theme(bg = "#036d7a", fg = "white"),
  value = uiOutput("n1_complete_length"),
  showcase = plotlyOutput("n1_sparkline_length")
)
```

### Row

```{r}
#| label: VB 3length
value_box(
  id = "card3",
  title = "Substations area (km²)",
  theme = value_box_theme(bg = "#54a36a", fg = "white"),
  value = uiOutput("n3_complete_length"),
  showcase = plotlyOutput("n3_sparkline_length")
)
```


```{r}
#| label: display 3 valuebox length
#| context: server

output$n1_complete_length <- renderUI({
  
  if (nrow(value_world_circuits_length()) == 0) { #on n'affiche rien qd df vide (sinon error affichée)
    "-" } else {
      
  tags$div(tags$div(style = "font-size: 1.2em;", 
                    value_world_circuits_last_length()$length),
    tags$div(style = "font-size: 0.5em; margin-top: 12px; opacity: 0.9;",
             tags$div(tags$img(src = "images/myg_24h.svg",                                 
                               style = "height: 25px; vertical-align: top; margin-right: 5px; filter: brightness(0) invert(1);"), 
                      tags$span(style = "font-size: 1.5em;", value_world_circuits_24H_length()$length),
                      if(value_world_circuits_last_length()$length > value_world_circuits_24H_length()$length) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"), 
                                paste0("+", value_world_circuits_24H_length()$growth_rate, "%"))
                        } else if(value_world_circuits_last_length()$length < value_world_circuits_24H_length()$length) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(value_world_circuits_24H_length()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #FFA500;", "=") 
                            }),
             tags$div(style = "margin-top: 2px;",
                      tags$img(src = "images/myg_1m.svg",                                 
                               style = "height: 25px; vertical-align: top; margin-right: 5px; filter: brightness(0) invert(1);"), 
                      tags$span(style = "font-size: 1.5em;", value_world_circuits_month1_length()$length),
                      if(value_world_circuits_last_length()$length > value_world_circuits_month1_length()$length) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"),
                                paste0("+", value_world_circuits_month1_length()$growth_rate, "%"))
                        } else if(value_world_circuits_last_length()$length < value_world_circuits_month1_length()$length) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(value_world_circuits_month1_length()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #FFA500;", "=")
                            })))
    }
})
output$n1_sparkline_length <- renderPlotly({
  plotly_time_series(value_world_circuits_length(),
                     x = ~x, y = ~length,
                     my_title = input$nom_pays_length)
  })
output$n2_complete_length <- renderUI({
  
  if (value_world_lines_last_length()$length == "NA") { #on n'affiche rien qd df vide (sinon error affichée)
    "-" } else {
      
  tags$div(tags$div(style = "font-size: 1.2em;", 
                    ifelse(value_world_lines_last_length()$length == "NA", "", value_world_lines_last_length()$length)),
    tags$div(style = "font-size: 0.5em; margin-top: 12px; opacity: 0.9;",
             tags$div(tags$img(src = "images/myg_24h.svg",                                 
                               style = "height: 25px; vertical-align: top; margin-right: 5px;"), 
                      tags$span(style = "font-size: 1.5em;", value_world_lines_24H_length()$length),
                      if(value_world_lines_last_length()$length > value_world_lines_24H_length()$length) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"), 
                                paste0("+", value_world_lines_24H_length()$growth_rate, "%"))
                        } else if(value_world_lines_last_length()$length < value_world_lines_24H_length()$length) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(value_world_lines_24H_length()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #FFA500;", "=") 
                            }),
             tags$div(style = "margin-top: 2px;",
                      tags$img(src = "images/myg_1m.svg",                                 
                               style = "height: 25px; vertical-align: top; margin-right: 5px;"), 
                      tags$span(style = "font-size: 1.5em;", value_world_lines_month1_length()$length),
                      if(value_world_lines_last_length()$length > value_world_lines_month1_length()$length) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"),
                                paste0("+", value_world_lines_month1_length()$growth_rate, "%"))
                        } else if(value_world_lines_last_length()$length < value_world_lines_month1_length()$length) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(value_world_lines_month1_length()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #FFA500;", "=")
                            })))
    }
})
output$n2_sparkline_length <- renderPlotly({
  plotly_time_series(value_world_lines_length(),
                     x = ~x, y = ~length,
                     my_title = input$nom_pays_length)
  })
output$n3_complete_length <- renderUI({
  
  if (value_world_substations_last_length()$area == "NA") { #on n'affiche rien qd df vide (sinon error affichée)
    "-" } else {
      
  tags$div(tags$div(style = "font-size: 1.2em;", 
                    ifelse(value_world_substations_last_length()$area == "NA", "",
                           value_world_substations_last_length()$area)),
    tags$div(style = "font-size: 0.5em; margin-top: 12px; opacity: 0.9;",
             tags$div(tags$img(src = "images/myg_24h.svg",                                 
                               style = "height: 25px; vertical-align: top; margin-right: 5px; filter: brightness(0) invert(1);"), 
                      tags$span(style = "font-size: 1.5em;", value_world_substations_24H_length()$area),
                        if(value_world_substations_last_length()$area > value_world_substations_24H_length()$area) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"), 
                                paste0("+", value_world_substations_24H_length()$growth_rate, "%"))
                        } else if(value_world_substations_last_length()$area < value_world_substations_24H_length()$area) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(value_world_substations_24H_length()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #FFA500;", "=") 
                            }),
             tags$div(style = "margin-top: 2px;",
                      tags$img(src = "images/myg_1m.svg",                                 
                               style = "height: 25px; vertical-align: top; margin-right: 5px; filter: brightness(0) invert(1);"), 
                      tags$span(style = "font-size: 1.5em;", value_world_substations_month1_length()$area),
                      if(value_world_substations_last_length()$area > value_world_substations_month1_length()$area) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"),
                                paste0("+", value_world_substations_month1_length()$growth_rate, "%"))
                        } else if(value_world_substations_last_length()$area < value_world_substations_month1_length()$area) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(value_world_substations_month1_length()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #FFA500;", "=")
                            })))
    }
})
output$n3_sparkline_length <- renderPlotly({
  plotly_time_series(value_world_substations_length(),
                     x = ~x, y = ~area,
                     my_title = input$nom_pays_length)
  })
```


## Column {width="80%"}

### Row


#### Column {width="60%"}



```{r}
#| context: server
#| label: prepare data evolution 100 graph length

# Préparation des données
circuits_mars25_length <- reactive({
  value_world_circuits_length() |> 
    filter(as.Date(x) == "2025-03-01")
})
line_mars25_length <- reactive({
  value_world_lines_length() |> 
    filter(as.Date(x) == "2025-03-01")
})
substations_mars25_length <- reactive({
  value_world_substations_length() |> 
    filter(as.Date(x) == "2025-03-01")
})
table_length <- reactive({
  left_join(value_world_lines_length() |> select(c(x, length, Pays)) |> rename(length_segments = length), 
            value_world_substations_length() |> select(c(x, area, Pays)) |> rename(area_substations = area), 
            by = "x") |> 
  left_join(value_world_circuits_length() |> select(c(x, length, Pays)) |> rename(length_circuits = length),
            by = "x") |> 
  arrange(x) |> 
  #transformation des métriques en base 100 en mars 2025
  mutate(length_circuits_100_mars25 = ifelse(is.na(length_circuits), NA_real_, length_circuits / circuits_mars25_length()$length * 100),
         length_circuits_100_diff = ifelse(is.na(length_circuits), NA_real_, round(length_circuits_100_mars25 - 100, 1)),
         length_circuits_diff = ifelse(is.na(length_circuits), NA_real_, length_circuits - circuits_mars25_length()$length),
         length_segments_100_mars25 = ifelse(is.na(length_segments), NA_real_, length_segments / line_mars25_length()$length * 100), 
         length_segments_100_diff = ifelse(is.na(length_segments), NA_real_, round(length_segments_100_mars25 - 100, 1)),
         length_segments_diff = ifelse(is.na(length_segments), NA_real_, round(length_segments - line_mars25_length()$length, 0)), 
         area_substations_100_mars25 = ifelse(is.na(area_substations), NA_real_, area_substations / substations_mars25_length()$area * 100),
         area_substations_100_diff = ifelse(is.na(area_substations), NA_real_, round(area_substations_100_mars25 - 100, 1)),
         area_substations_diff = ifelse(is.na(area_substations), NA_real_, area_substations - substations_mars25_length()$area))
})
  #calcul de la valeur minimale en base 100 (pour placer geom_rect)
min_mesures_length <- reactive({
  c(ifelse(is.na(table_length()$length_circuits), NA_real_, min(table()$length_circuits_100_mars25, na.rm = TRUE)),
    ifelse(is.na(table_length()$length_segments), NA_real_, min(table()$length_segments_100_mars25, na.rm = TRUE)),
    ifelse(is.na(table_length()$area_substations), NA_real_, min(table()$area_substations_100_mars25, na.rm = TRUE)))
})
min_min_100_length <- reactive({
  min(min_mesures_length(), na.rm = TRUE)
})
  #calcul de la valeur maximale en base 100 (pour placer geom_rect)
max_mesures_length <- reactive({
  c(ifelse(is.na(table_length()$length_circuits), NA_real_, max(table()$length_circuits_100_mars25, na.rm = TRUE)),
    ifelse(is.na(table_length()$length_segments), NA_real_, max(table()$length_segments_100_mars25, na.rm = TRUE)),
    ifelse(is.na(table_length()$area_substations), NA_real_, max(table()$area_substations_100_mars25, na.rm = TRUE)))
})
max_max_100_length <- reactive({
  max(max_mesures_length(), na.rm = TRUE)
})
```


```{r}
#| title: Evolutions base 100 in March 2025
plotlyOutput('plot5_length')
```

```{r}
#| context: server
#| label: graph base 100 length

# Plot
output$plot5_length <- renderPlotly({
  
  if (nrow(table_length()) == 0 | (all(is.na(table_length()$length_circuits_100_mars25)) &
                                   all(is.na(table_length()$length_segments_100_mars25)) &
                                   all(is.na(table_length()$area_substations_100_mars25)))) {
    # Créer un plotly vide avec message
    plot_ly() |>
      layout(
        xaxis = list(showgrid = FALSE, showticklabels = FALSE, zeroline = FALSE),
        yaxis = list(showgrid = FALSE, showticklabels = FALSE, zeroline = FALSE),
        annotations = list(
          list(
            text = "No data for this country",
            xref = "paper",
            yref = "paper",
            x = 0.5,
            y = 0.5,
            showarrow = FALSE,
            font = list(size = 16, color = "gray")
          )
        )
      )
  } else {

  #plot depending on selected country
  graph <- table_length() |> 
    mutate(x = as.Date(x)) |> 
    ggplot() +
    #distinction des périodes du projet
    # geom_rect(aes(xmin = as.Date("2024-11-01"), xmax = as.Date("2025-03-01"),
    #               ymin = min_min_100_length(), ymax = max_max_100_length(),
    #               text = "Early OET"), fill = "#333333", alpha = 0.2) +
    # geom_rect(aes(xmin = as.Date("2025-03-01"), xmax = as.Date("2025-08-01"),
    #               ymin = min_min_100_length(), ymax = max_max_100_length(),
    #               text = "Kickoff"), fill = "#a2a2a3", alpha = 0.2) +
    # geom_rect(aes(xmin = as.Date("2025-08-01"), xmax = max(x),
    #               ymin = min_min_100_length(), ymax = max_max_100_length(),
    #               text = "Public launch"), fill = "#656566", alpha = 0.2) +
    #ligne colorée jusqu'à 100 pour segments
    geom_line(aes(x = x, y = length_segments_100_mars25, group = 1, 
                  text = case_when(length_segments_100_diff < 0 ~ paste0("Time : ", x, "\n↓ ", abs(length_segments_100_diff), 
                    "% (", format(as.integer(length_segments_diff, 0), nsmall = 1, big.mark = ","), " km of line length"),
                                   length_segments_100_diff == 0 ~ "Base 100",
                                   .default = paste0("Time : ", x, "\n↑ ", abs(length_segments_100_diff), 
                    "% (+", format(as.integer(length_segments_diff, 0), nsmall = 1, big.mark = ","), " km of line length")),
                  color = "Lines"), linewidth = .7) +
    #ligne colorée jusqu'à 100 pour circuits
    geom_line(aes(x = x, y = length_circuits_100_mars25,group = 1,
                  text = case_when(length_circuits_100_diff < 0 ~ paste0("Time : ", x, "\n↓ ", abs(length_circuits_100_diff), 
                    "% (", format(as.integer(length_circuits_diff, 0), nsmall = 1, big.mark = ","), " km of circuits relations length)"),
                                   length_circuits_100_diff == 0 ~ "Base 100",
                                   .default = paste0("Time : ", x, "\n↑ ", abs(length_circuits_100_diff), 
                    "% (+", format(as.integer(length_circuits_diff, 0), nsmall = 1, big.mark = ","), " km of circuits relations length)")),
                  color = "Circuits \nrelations"), linewidth = .7) +
    #ligne colorée jusqu'à 100 pour substations
    geom_line(aes(x = x, y = area_substations_100_mars25, group = 1, 
                  text = case_when(area_substations_100_diff < 0 ~ paste0("Time : ", x, "\n↓ ", abs(area_substations_100_diff), 
                    "% (", format(as.integer(area_substations_diff, 0), nsmall = 1, big.mark = ","), " km² of substations area"),
                                   area_substations_100_diff == 0 ~ "Base 100",
                                   .default = paste0("Time : ", x, "\n↑ ", abs(area_substations_100_diff), 
                    "% (+", format(as.integer(area_substations_diff, 0), nsmall = 1, big.mark = ","), " km² of substations area)")),
                  color = "Substations"), linewidth = .7) +
    #ligne pointillée au 1er mars 2025
    #geom_vline(xintercept = as.Date("2025-03-01"), linetype = 2, color = "red4") +
    #mises en forme générales
    scale_x_date(date_labels = "%m-%y", breaks = pretty_breaks(n = 7)) +
    scale_y_continuous(labels = scales::comma) +
    scale_color_manual(values = c("Lines" = "#ecc123", 
                                  "Circuits \nrelations" = "#036d7a",
                                  "Substations" = "#54a36a")) +
    labs(x = "Time", 
         y = "Base 100 in 03-2025", 
         color = "") + 
    theme_custom() +
    theme(axis.ticks.x = element_line(color = "#cbcbcb"),
          legend.position = "top",
          panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
          panel.grid.minor.x = ggplot2::element_line(color = "#cbcbcb")) +
    guides(color = guide_legend(nrow = 2))
  #interactive graph
  ggplotly(graph, tooltip = c("text")) |> 
    layout(yaxis = list(autorange = TRUE),
           showlegend = TRUE,  # Légende affichée par défaut
           updatemenus = list(list(type = "buttons", direction = "left", 
                                   xanchor = "center", yanchor = "top", x = 0.5, y = 1.15,
                                   buttons = list(list(method = "relayout", 
                                                       args = list("showlegend", TRUE), 
                                                       label = "Show legend"),
                                                  list(method = "relayout", 
                                                       args = list("showlegend", FALSE),
                                                       label = "Hide legend")))))
  }
})
```

#### Column {width="35%"}


```{r}
#| context: server
#| label: prepare data growth rate graph length

# Préparation des données
    #line
lines1 <- reactive({
  value_world_lines_length() |> 
    mutate(x = as.Date(x)) |> 
    filter(x == "2025-03-01" | x == max(x, na.rm = TRUE)) |> 
    mutate(growth_rate_segments = (length - lag(length)) / lag(length)) |> 
    select(growth_rate_segments) |> 
    na.omit()
})
    #circuits
circuits1 <- reactive({
  value_world_circuits_length() |> 
    mutate(x = as.Date(x)) |> 
    filter(x == "2025-03-01" | x == max(x, na.rm = TRUE)) |> 
    mutate(growth_rate_circuits = (length - lag(length)) / lag(length)) |> 
    select(growth_rate_circuits) |> 
    na.omit()
})
    #substations
substations1 <- reactive({
  value_world_substations_length() |> 
    mutate(x = as.Date(x)) |> 
    filter(x == "2025-03-01" | x == max(x, na.rm = TRUE)) |> 
    mutate(growth_rate_substations = (area - lag(area)) / lag(area)) |> 
    select(growth_rate_substations) |> 
    na.omit()
})

dfs_list <- reactive({
  list(lines1(), circuits1(), substations1())
})
dfs_non_vides <- reactive({
  Filter(function(x) nrow(x) > 0, dfs_list())
})
dfs_non_vides_binded <- reactive({
  bind_cols(dfs_non_vides())
})
growth_rate_length <- reactive({
  df_input <- dfs_non_vides_binded()
  if (nrow(df_input) == 0 || ncol(df_input) == 0) {
    return(data.frame(Mesure = character(), Valeur = numeric()))
  }
  df_input |> 
    pivot_longer(cols = everything(), values_to = "Valeur", names_to = "Mesure", names_prefix = "growth_rate_") |> 
    mutate(Mesure = gsub("^([[:alpha:]])(.*)$", "\\U\\1\\L\\2", Mesure, perl = TRUE)) |> 
    mutate(Mesure = str_replace_all(Mesure, c("Circuits" = "Circuits relations", "Segments" = "Lines")))
})

# growth_rate_length <- reactive({
#   bind_cols(dfs_non_vides()) |> 
#     pivot_longer(cols = everything(), values_to = "Valeur", names_to = "Mesure", names_prefix = "growth_rate_") |> 
#     mutate(Mesure = gsub("^([[:alpha:]])(.*)$", "\\U\\1\\L\\2", Mesure, perl = TRUE))
# })
```

```{r}
#| title: Growth rate since March 2025
plotlyOutput('plot6_length')
```

```{r}
#| context: server
#| label: graph growth rate length

# Plot line length
output$plot6_length <- renderPlotly({
  
    if (nrow(growth_rate_length()) == 0) {
    # Créer un plotly vide avec message
    plot_ly() |>
      layout(
        xaxis = list(showgrid = FALSE, showticklabels = FALSE, zeroline = FALSE),
        yaxis = list(showgrid = FALSE, showticklabels = FALSE, zeroline = FALSE),
        annotations = list(
          list(
            text = "No data for this country",
            xref = "paper",
            yref = "paper",
            x = 0.5,
            y = 0.5,
            showarrow = FALSE,
            font = list(size = 16, color = "gray")
          )
        )
      )
  } else {

  #plot depending on selected country
  graph <- growth_rate_length() |> 
    mutate(Mesure = factor(Mesure, levels = c("Substations", "Circuits relations", "Lines"))) |> 
    ggplot() +
    geom_segment(aes(x = 0, xend = Valeur, y = Mesure, yend = Mesure, color = Mesure), linewidth = 1) +
    geom_point(aes(x = Valeur, y = Mesure, color = Mesure,
                   text = paste("+", round(Valeur*100, 2), "%")), size = 4) +
    labs(y = "", x = "Growth rate (%)") +
    scale_color_manual(values = c("Lines" = "#ecc123",
                                  "Circuits relations" = "#036d7a",
                                  "Substations" = "#54a36a")) +
    scale_x_continuous(labels = scales::percent) +
    scale_y_discrete(labels = function(x) stringr::str_wrap(x, width = 10)) + #axis-text trop longs sur plusieurs lignes
    theme_custom() +
    theme(legend.position = "none", 
          panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
          panel.grid.major.y = ggplot2::element_blank()) 
  #interactive graph
  ggplotly(graph, tooltip = c("text")) |> 
    layout(xaxis = list(tickmode = "auto", tickformat = ".0%"))
  } 
})
```


# Tables

```{r}
#| label: import data tables

line_length_country <- read_csv("/data/api/line_length_growth_table2.csv", show_col_types = FALSE)
```

## Row

### Column {width="60%"}

```{r}
#| title: Line length growth per country (click on any column header to sort the table)
#| label: table per country

# Préparation des données

  #chargement du dataset countrypops (codes des pays)
data("countrypops")
countrypops <- countrypops |> 
  distinct(country_name, country_code_2, country_code_3) |> 
  mutate(country_name = tolower(str_replace(country_name, "&", "and"))) 

  #jointure avec nos données pour récupérer le code de pays 
laste_date <- (line_length_country |> distinct(x))$x
line_length_country_prep0 <- line_length_country |> 
  mutate(Country2 = tolower(Country), #minuscules pour otpimiser le match
         Country2 = case_match(Country2, #remplace à la main des pays non matchés
                               "people's republic of china" ~ "china",
                               "ivory coast" ~ "cote d'ivoire",
                               "state of palestine" ~ "palestine",
                               "democratic republic of the congo" ~ "congo (drc)",
                               "republic of the congo" ~ "congo (republic)",
                               "the bahamas" ~ "bahamas",
                               "the gambia" ~ "gambia",
                               "timor-leste" ~ "east timor",
                               "federated states of micronesia" ~ "micronesia",
                               "são tomé and príncipe" ~ "sao tome and principe",
                               "kingdom of the netherlands" ~ "netherlands",
                               "united states of america" ~ "united states",
                               "republic of ireland" ~ "ireland",
                               #"taiwan" ~ "united states",
                               .default = Country2)) |> 
  left_join(countrypops, by = c("Country2" = "country_name")) |> 
  #mise en forme df
  select(-Country2) |> 
  relocate(country_code_2, .before = Country) |> 
  relocate(labels.transmission.length, .after = Country) |> 
  mutate(labels.transmission.length = round(labels.transmission.length, 0)) |> 
  mutate_at(vars(starts_with("growth_km")), ~round(., 0)) |> 
  rename(` ` = country_code_2)
line_length_country_prep <- line_length_country_prep0 |> 
  #rename(`Growth since 2025-01-01 (km)` = growth_km,
  #       `Growth since 2025-01-01 (%)` = growth_percent) |> 
  rename_with(~ paste("Power line length (km)", laste_date), .cols = labels.transmission.length)
         

# Affichage de la table
table_line_country <- line_length_country_prep |> 
  arrange(Country) |> 
  gt() |> 
  #drapeaux par pays
  fmt_flag(columns = ` `) |> 
  #format colonne en %
  fmt_percent(columns = c(growth_percent_earlyOET, growth_percent_kickoff, growth_percent_publicLaunch),
            decimals = 1, drop_trailing_zeros = TRUE,
            dec_mark = ",") |> 
  #coloration des évolutions en %
  data_color(columns = c(growth_percent_earlyOET, growth_percent_kickoff, growth_percent_publicLaunch),
             rows = growth_percent_earlyOET != 0 | growth_percent_kickoff != 0 | growth_percent_publicLaunch != 0,
             method = "bin",
             apply_to = "text",
             palette = c("#bf2f2f", "black", "#279f2b"),
             bins = c(-1, 0, 1)) |> 
  #coloration des évolutions en valeurs absolues
  data_color(columns = c(growth_km_earlyOET, growth_km_kickoff, growth_km_publicLaunch),
             rows = growth_km_earlyOET > 0 | growth_km_kickoff > 0 | growth_km_publicLaunch > 0,
             method = "numeric",
             palette = c("#FECF5D", "#279f2b"),
             bins = c(-Inf, 0, Inf),
             alpha = .8) |>
  data_color(columns = c(growth_km_earlyOET, growth_km_kickoff, growth_km_publicLaunch),
             rows = growth_km_earlyOET < 0 | growth_km_kickoff < 0 | growth_km_publicLaunch < 0,
             method = "numeric",
             palette = c("#bf2f2f", "#ffa500"),
             bins = c(-Inf, 0, Inf),
             alpha = .8) |>
  data_color(columns = c(growth_km_earlyOET, growth_km_kickoff, growth_km_publicLaunch),
             rows = growth_km_earlyOET == 0 | growth_km_kickoff == 0 | growth_km_publicLaunch == 0,
             method = "numeric",
             palette = c("grey80"),
             bins = c(-Inf, 0, Inf),
             alpha = .8) |>
  #alternance gris / blanc par ligne
  opt_row_striping() |> 
  #centrer les nombres
  tab_style(style = cell_text(align = "center"),
            locations = cells_body(is.numeric)) |> 
  #noms de pays en gras
  tab_style(style = cell_text(weight = "bold"),
            locations = cells_body(Country)) |> 
  #mise en forme des noms de colonnes
  tab_style(style = cell_text(align = "left"),
            locations = cells_column_labels()) |> 
  #bordures en blanc
  tab_options(table_body.hlines.style = "solid",
              table_body.hlines.width = 10, 
              table_body.hlines.color = "white") |> 
  #taille colonnes
  cols_width(` ` ~ px(30)) |> 
  #intéractivité table
  opt_interactive(use_pagination = FALSE, use_search = TRUE) |> 
  #cache colonne
  cols_hide(c(country_code_3, x)) |> 
  #groupe de colonnes
    # Early OET
  tab_spanner(label = "Early OET (from 2024-11-01 to 2025-02-30)",
              columns = c(growth_percent_earlyOET, growth_km_earlyOET)) |> 
  cols_label(growth_percent_earlyOET = "Growth (%)", growth_km_earlyOET = "Growth (km)") |> 
    # Kickoff
  tab_spanner(label = "Kickoff (from 2025-03-01 to 2025-07-31)",
              columns = c(growth_percent_kickoff, growth_km_kickoff)) |> 
  cols_label(growth_percent_kickoff = "Growth (%)", growth_km_kickoff = "Growth (km)") |> 
    # Early OET
  tab_spanner(label = paste0("Public launch (from 2025-08-01 to ", laste_date, ")"),
              columns = c(growth_percent_publicLaunch, growth_km_publicLaunch)) |> 
  cols_label(growth_percent_publicLaunch = "Growth (%)", growth_km_publicLaunch = "Growth (km)")
table_line_country
```

### Column {width="40%"}

#### Row {height="50%" .tabset}

```{r}
#| label: pre-run tables per continent

# Préparation des données

  #chargement des données des pays avec continent correspondant
continent_data <- read_delim("https://public.opendatasoft.com/api/explore/v2.1/catalog/datasets/world-administrative-boundaries/exports/csv/?delimiters=%3B&lang=fr&timezone=Europe%2FParis&use_labels=true", ";") |> 
  distinct(`ISO 3 territory code`, `Continent of the territory`) |> 
  clean_names()

  #jointure avec nos données pour récupérer le code de pays 
line_length_country_prep2 <- line_length_country_prep0 |> 
  mutate(country_code_3 = ifelse(Country == "Taiwan", "TWN", country_code_3)) |> 
  left_join(continent_data, by = c("country_code_3" = "iso_3_territory_code")) |> 
    #agrégation par continent
  summarise(nb_pays = n(),
            mean_power_line = round(mean(labels.transmission.length), 0),
            min_power_line = min(labels.transmission.length),
            max_power_line = max(labels.transmission.length),
            sum_power_line = sum(labels.transmission.length),
            min_growth_percent_earlyOET = min(growth_percent_earlyOET),
            max_growth_percent_earlyOET = max(growth_percent_earlyOET),
            mean_growth_percent_earlyOET = mean(growth_percent_earlyOET),
            min_growth_percent_kickoff = min(growth_percent_kickoff),
            max_growth_percent_kickoff = max(growth_percent_kickoff),
            mean_growth_percent_kickoff = mean(growth_percent_kickoff),
            min_growth_percent_publicLaunch = min(growth_percent_publicLaunch),
            max_growth_percent_publicLaunch = max(growth_percent_publicLaunch),
            mean_growth_percent_publicLaunch = mean(growth_percent_publicLaunch),
            .by = continent_of_the_territory)

```

```{r}
#| title: Current length
#| label: length per continent
      ###----- Power line length (km)

# Affichage de la table
table_line_continent_power <- line_length_country_prep2 |> 
  #sélection des variables à afficher
  select(continent_of_the_territory, nb_pays, ends_with("power_line")) |> 
  #dernière mise en forme avant table
  rename(`Number of countries` = nb_pays,
         Continent = continent_of_the_territory) |> 
  #table
  gt() |> 
  #coloration des moyennes
  data_color(columns = mean_power_line,
             colors = scales::col_numeric(palette = c("#faf1d0", "#f1d365"), domain = NULL)) |> 
  #groupe de statistiques
  tab_spanner(label = paste("Power line length (km)", laste_date),
              columns = c(mean_power_line, min_power_line, max_power_line, sum_power_line)) |> 
  cols_label(sum_power_line = "Sum", min_power_line = "Min", 
             max_power_line = "Max", mean_power_line = "Mean") |> 
  #alternance gris / blanc par ligne
  opt_row_striping() |> 
  #centrer les nombres
  tab_style(style = cell_text(align = "center"),
            locations = cells_body(-Continent)) |> 
  #lighter les nombres sauf nb_countries
  tab_style(style = cell_text(weight = "lighter"),
            locations = cells_body(-c(Continent, `Number of countries`))) |> 
  #noms de continent en gras
  tab_style(style = cell_text(weight = "bold"),
            locations = cells_body(Continent)) |> 
  #mise en forme des noms de colonnes
  tab_style(style = list(cell_text(align = "center")),
            locations = cells_column_labels()) |> 
  #styles de la table
  opt_stylize(style = 1, color = 'gray') |> 
  #bordures en blanc
  tab_options(table_body.hlines.style = "solid",
              table_body.hlines.width = 2, 
              table_body.hlines.color = "white",
              table_body.border.top.color = "#6b6b6b",
              table_body.border.top.style = "solid",
              table_body.border.top.width = 2.4)
table_line_continent_power
```

```{r}
#| title: Early OET
#| label: earlyOET per continent

# Affichage de la table
table_line_continent_growth_percent <- line_length_country_prep2 |> 
  #sélection des variables à afficher
  select(continent_of_the_territory, nb_pays, ends_with("_earlyOET")) |> 
  #dernière mise en forme avant table
  rename(`Number of countries` = nb_pays,
         Continent = continent_of_the_territory,
         mean_growth_percent = mean_growth_percent_earlyOET,
         min_growth_percent = min_growth_percent_earlyOET,
         max_growth_percent = max_growth_percent_earlyOET) |> 
  #table
  gt() |> 
  #coloration des moyennes
  data_color(columns = mean_growth_percent,
             colors = scales::col_numeric(palette = c("#b3d3d7", "#036d7a"), domain = NULL)) |> 
  #groupe de statistiques
  tab_spanner(label = 'Growth from 2024-11-01 to 2025-02-30 (%)',
              columns = c(mean_growth_percent, min_growth_percent, max_growth_percent)) |> 
  cols_label(min_growth_percent = "Min", max_growth_percent = "Max", mean_growth_percent = "Mean") |> 
    #alternance gris / blanc par ligne
  opt_row_striping() |> 
  #centrer les nombres
  tab_style(style = cell_text(align = "center"),
            locations = cells_body(-Continent)) |> 
  #lighter les nombres sauf nb_countries
  tab_style(style = cell_text(weight = "lighter"),
            locations = cells_body(-c(Continent, `Number of countries`))) |> 
  #noms de continent en gras
  tab_style(style = cell_text(weight = "bold"),
            locations = cells_body(Continent)) |> 
  #mise en forme des noms de colonnes
  tab_style(style = list(cell_text(align = "center")),
            locations = cells_column_labels()) |> 
  #styles de la table
  opt_stylize(style = 1, color = 'gray') |> 
  #bordures en blanc
  tab_options(table_body.hlines.style = "solid",
              table_body.hlines.width = 2, 
              table_body.hlines.color = "white",
              table_body.border.top.color = "#6b6b6b",
              table_body.border.top.style = "solid",
              table_body.border.top.width = 2.4) |> 
  #format colonne en %
  fmt_percent(columns = c(min_growth_percent, max_growth_percent, mean_growth_percent),
            decimals = 2, drop_trailing_zeros = TRUE,
            dec_mark = ",")
table_line_continent_growth_percent
```

```{r}
#| title: Kickoff
#| label: kickoff per continent

# Affichage de la table
table_line_continent_growth_percent <- line_length_country_prep2 |> 
  #sélection des variables à afficher
  select(continent_of_the_territory, nb_pays, ends_with("_kickoff")) |> 
  #dernière mise en forme avant table
  rename(`Number of countries` = nb_pays,
         Continent = continent_of_the_territory,
         mean_growth_percent = mean_growth_percent_kickoff,
         min_growth_percent = min_growth_percent_kickoff,
         max_growth_percent = max_growth_percent_kickoff) |> 
  #table
  gt() |> 
  #coloration des moyennes
  data_color(columns = mean_growth_percent,
             colors = scales::col_numeric(palette = c("#b3d3d7", "#036d7a"), domain = NULL)) |> 
  #groupe de statistiques
  tab_spanner(label = 'Growth from 2025-03-01 to 2025-07-31 (%)',
              columns = c(mean_growth_percent, min_growth_percent, max_growth_percent)) |> 
  cols_label(min_growth_percent = "Min", max_growth_percent = "Max", mean_growth_percent = "Mean") |> 
    #alternance gris / blanc par ligne
  opt_row_striping() |> 
  #centrer les nombres
  tab_style(style = cell_text(align = "center"),
            locations = cells_body(-Continent)) |> 
  #lighter les nombres sauf nb_countries
  tab_style(style = cell_text(weight = "lighter"),
            locations = cells_body(-c(Continent, `Number of countries`))) |> 
  #noms de continent en gras
  tab_style(style = cell_text(weight = "bold"),
            locations = cells_body(Continent)) |> 
  #mise en forme des noms de colonnes
  tab_style(style = list(cell_text(align = "center")),
            locations = cells_column_labels()) |> 
  #styles de la table
  opt_stylize(style = 1, color = 'gray') |> 
  #bordures en blanc
  tab_options(table_body.hlines.style = "solid",
              table_body.hlines.width = 2, 
              table_body.hlines.color = "white",
              table_body.border.top.color = "#6b6b6b",
              table_body.border.top.style = "solid",
              table_body.border.top.width = 2.4) |> 
  #format colonne en %
  fmt_percent(columns = c(min_growth_percent, max_growth_percent, mean_growth_percent),
            decimals = 2, drop_trailing_zeros = TRUE,
            dec_mark = ",")
table_line_continent_growth_percent
```

```{r}
#| title: Public launch
#| label: public launch per continent

# Affichage de la table
table_line_continent_growth_percent <- line_length_country_prep2 |> 
  #sélection des variables à afficher
  select(continent_of_the_territory, nb_pays, ends_with("_publicLaunch")) |> 
  #dernière mise en forme avant table
  rename(`Number of countries` = nb_pays,
         Continent = continent_of_the_territory,
         mean_growth_percent = mean_growth_percent_publicLaunch,
         min_growth_percent = min_growth_percent_publicLaunch,
         max_growth_percent = max_growth_percent_publicLaunch) |> 
  #table
  gt() |> 
  #coloration des moyennes
  data_color(columns = mean_growth_percent,
             colors = scales::col_numeric(palette = c("#b3d3d7", "#036d7a"), domain = NULL)) |> 
  #groupe de statistiques
  tab_spanner(label = paste0("Public launch (from 2025-08-01 to ", laste_date, ")"),
              columns = c(mean_growth_percent, min_growth_percent, max_growth_percent)) |> 
  cols_label(min_growth_percent = "Min", max_growth_percent = "Max", mean_growth_percent = "Mean") |> 
    #alternance gris / blanc par ligne
  opt_row_striping() |> 
  #centrer les nombres
  tab_style(style = cell_text(align = "center"),
            locations = cells_body(-Continent)) |> 
  #lighter les nombres sauf nb_countries
  tab_style(style = cell_text(weight = "lighter"),
            locations = cells_body(-c(Continent, `Number of countries`))) |> 
  #noms de continent en gras
  tab_style(style = cell_text(weight = "bold"),
            locations = cells_body(Continent)) |> 
  #mise en forme des noms de colonnes
  tab_style(style = list(cell_text(align = "center")),
            locations = cells_column_labels()) |> 
  #styles de la table
  opt_stylize(style = 1, color = 'gray') |> 
  #bordures en blanc
  tab_options(table_body.hlines.style = "solid",
              table_body.hlines.width = 2, 
              table_body.hlines.color = "white",
              table_body.border.top.color = "#6b6b6b",
              table_body.border.top.style = "solid",
              table_body.border.top.width = 2.4) |> 
  #format colonne en %
  fmt_percent(columns = c(min_growth_percent, max_growth_percent, mean_growth_percent),
            decimals = 2, drop_trailing_zeros = TRUE,
            dec_mark = ",")
table_line_continent_growth_percent
```

#### Row {height="50%"}


```{r}
#| title: Total line length's per continent
#| label: barplot per continent


data_graph <- line_length_country_prep0 |> 
  mutate(country_code_3 = ifelse(Country == "Taiwan", "TWN", country_code_3)) |> 
  left_join(continent_data, by = c("country_code_3" = "iso_3_territory_code")) |> 
    #agrégation par continent
  summarise(sum_power_line = sum(labels.transmission.length),
            .by = continent_of_the_territory) |> 
  mutate(continent_of_the_territory = fct_reorder(continent_of_the_territory, sum_power_line))
graph <- data_graph |> 
  ggplot() +
  geom_col(aes(x = continent_of_the_territory, y = max(sum_power_line)), fill = "#F3F3F3", width = .85) +
  geom_col(aes(x = continent_of_the_territory, y = sum_power_line,
               text = paste(format(as.integer(sum_power_line, 0), nsmall = 1, big.mark = ","), "km")), 
           fill = "#f1d365", width = .85) +
  scale_y_continuous(labels = scales::comma) + 
  coord_flip() +
  labs(y = "Line length (km)") +
  theme_custom() +
  theme(panel.grid.major.x = ggplot2::element_blank(),
        panel.grid.major.y = ggplot2::element_blank(),
        axis.title.y = element_blank())
ggplotly(graph, tooltip = c("text"))
```


# Mappers

```{r}
#| label: import data mappers to get last update

df_mappers_lines <- read_csv("/data/api/mappers_lines_all.csv", show_col_types = FALSE, col_select = c(x, Pays))
last_date_mappers <- df_mappers_lines |> 
  arrange(x) |> 
  slice_tail(n = 1)
first_date_mappers <- df_mappers_lines |> 
  arrange(x) |> 
  slice_head(n = 1)
```

::: {.sidebar}


The data displayed on this dashboard are from **`r format(as.Date(first_date_mappers$x, format = "%Y-%m-%dT%H:%M:%S"),"%Y-%m-%d")`** to **`r format(as.Date(last_date_mappers$x, format = "%Y-%m-%dT%H:%M:%S"),"%Y-%m-%d %H:%M:%S")`**.

Transmission assets over **50 kV**.

------------------------------------------------------------------------


Select a **country** to view its indicators. By default, *global indicators* are shown.

```{r}
#| label: choix pays users

# Bouton de sélection du pays
selectInput('nom_pays_mappers', 'Country', unique(df_line$Pays), selected = "World (default)")
```

------------------------------------------------------------------------

Select a **time period** to display. 

```{r}
#| label: choix période

# Bouton de sélection de la période
radioButtons( 
    inputId = "time_period", 
    label = "Time period", 
    choices = c("Since the beginning of the project", "Last 30 days", "Last 24 hours"), 
    selected = "Since the beginning of the project")
```

:::


## Column {width="25%"}

### Row

```{r}
#| context: server
#| label: data and parameters depending on selected period and country


#--- SELECTED COUNTRY

# Circuits
mappers_circuits <- reactive({
  read_csv("/data/api/mappers_circuits_all.csv", show_col_types = FALSE) |> 
    filter(Pays == input$nom_pays_mappers)
})
# Lines
mappers_lines <- reactive({
  read_csv("/data/api/mappers_lines_all.csv", show_col_types = FALSE) |> 
    filter(Pays == input$nom_pays_mappers)
})
# Substations
mappers_substations <- reactive({
  read_csv("/data/api/mappers_substations_all.csv", show_col_types = FALSE) |> 
    filter(Pays == input$nom_pays_mappers)
})
# generators
mappers_generators <- reactive({
  read_csv("/data/api/mappers_generators_all.csv", show_col_types = FALSE) |> 
    rename(labels.transmission.amount_1d = amount_1d,
           labels.transmission.amount = amount,
           labels.transmission.amount_30d = amount_30d) |> #pas label transmission, mais on renomme pour que le graphique puisse se générer avec le nom de colonne correspondant
    filter(Pays == input$nom_pays_mappers)
})
# plants
mappers_plants <- reactive({
  read_csv("/data/api/mappers_plants_all.csv", show_col_types = FALSE) |> 
    rename(labels.transmission.amount_1d = amount_1d,
           labels.transmission.amount = amount,
           labels.transmission.amount_30d = amount_30d) |> #pas label transmission, mais on renomme pour que le graphique puisse se générer avec le nom de colonne correspondant
    filter(Pays == input$nom_pays_mappers)
})


#--- SELECTED PERIOD


# Circuits
mappers_circuits_period <- reactive({
  switch(input$time_period,
         "Since the beginning of the project" = mappers_circuits() |> 
           select(x, Pays, labels.transmission.amount) |> 
           rename(val = labels.transmission.amount),
         "Last 30 days" = mappers_circuits() |> 
           select(x, Pays, labels.transmission.amount_30d) |> 
           rename(val = labels.transmission.amount_30d),
         "Last 24 hours" = mappers_circuits() |> 
           select(x, Pays, labels.transmission.amount_1d) |> 
           rename(val = labels.transmission.amount_1d))
})
# Lines
mappers_lines_period <- reactive({
  switch(input$time_period,
         "Since the beginning of the project" = mappers_lines() |> 
           select(x, Pays, labels.transmission.amount) |> 
           rename(val = labels.transmission.amount),
         "Last 30 days" = mappers_lines() |> 
           select(x, Pays, labels.transmission.amount_30d) |> 
           rename(val = labels.transmission.amount_30d),
         "Last 24 hours" = mappers_lines() |> 
           select(x, Pays, labels.transmission.amount_1d) |> 
           rename(val = labels.transmission.amount_1d))
})
# Substations
mappers_substations_period <- reactive({
  switch(input$time_period,
         "Since the beginning of the project" = mappers_substations() |> 
           select(x, Pays, labels.transmission.amount) |> 
           rename(val = labels.transmission.amount),
         "Last 30 days" = mappers_substations() |> 
           select(x, Pays, labels.transmission.amount_30d) |> 
           rename(val = labels.transmission.amount_30d),
         "Last 24 hours" = mappers_substations() |> 
           select(x, Pays, labels.transmission.amount_1d) |> 
           rename(val = labels.transmission.amount_1d))
})
# generators
mappers_generators_period <- reactive({
  switch(input$time_period,
         "Since the beginning of the project" = mappers_generators() |> 
           select(x, Pays, labels.transmission.amount) |> 
           rename(val = labels.transmission.amount),
         "Last 30 days" = mappers_generators() |> 
           select(x, Pays, labels.transmission.amount_30d) |> 
           rename(val = labels.transmission.amount_30d),
         "Last 24 hours" = mappers_generators() |> 
           select(x, Pays, labels.transmission.amount_1d) |> 
           rename(val = labels.transmission.amount_1d))
})
# plants
mappers_plants_period <- reactive({
  switch(input$time_period,
         "Since the beginning of the project" = mappers_plants() |> 
           select(x, Pays, labels.transmission.amount) |> 
           rename(val = labels.transmission.amount),
         "Last 30 days" = mappers_plants() |> 
           select(x, Pays, labels.transmission.amount_30d) |> 
           rename(val = labels.transmission.amount_30d),
         "Last 24 hours" = mappers_plants() |> 
           select(x, Pays, labels.transmission.amount_1d) |> 
           rename(val = labels.transmission.amount_1d))
})

#--- VALUE BOXES


# Circuits
mappers_circuits_period_last <- reactive({
  mappers_circuits_period() |>
    arrange(desc(x)) |> 
    slice(1) |> 
    mutate(val = format(as.integer(val, 0), nsmall = 1, big.mark = ","))
})
mappers_world_circuits_24H <- reactive({
  mappers_circuits_period() |> 
    arrange(x) |> 
    slice_tail(n = 2) |> 
    mutate(growth_rate = round((val - lag(val)) / val *100, 2),
           val = format(as.integer(val, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})
mappers_world_circuits_month1 <- reactive({
  mappers_circuits_period() |> 
    arrange(x) |> 
    filter(x == max(x) | 
             x == as.Date(paste0(format(max(x), "%Y-%m"), "-01"))) |> 
    mutate(growth_rate = round((val - lag(val)) / val *100, 2),
           val = format(as.integer(val, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})
# Lines
mappers_lines_period_last <- reactive({
  mappers_lines_period() |>
    arrange(desc(x)) |> 
    slice(1) |> 
    mutate(val = format(as.integer(val, 0), nsmall = 1, big.mark = ","))
})
mappers_world_lines_24H <- reactive({
  mappers_lines_period() |> 
    arrange(x) |> 
    slice_tail(n = 2) |> 
    mutate(growth_rate = round((val - lag(val)) / val *100, 2),
           val = format(as.integer(val, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})
mappers_world_lines_month1 <- reactive({
  mappers_lines_period() |> 
    arrange(x) |> 
    filter(x == max(x) | 
             x == as.Date(paste0(format(max(x), "%Y-%m"), "-01"))) |> 
    mutate(growth_rate = round((val - lag(val)) / val *100, 2),
           val = format(as.integer(val, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})
# Substations
mappers_substations_period_last <- reactive({
  mappers_substations_period() |>
    arrange(desc(x)) |> 
    slice(1) |> 
    mutate(val = format(as.integer(val, 0), nsmall = 1, big.mark = ","))
})
mappers_world_substations_24H <- reactive({
  mappers_substations_period() |> 
    arrange(x) |> 
    slice_tail(n = 2) |> 
    mutate(growth_rate = round((val - lag(val)) / val *100, 2),
           val = format(as.integer(val, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})
mappers_world_substations_month1 <- reactive({
  mappers_substations_period() |> 
    arrange(x) |> 
    filter(x == max(x) | 
             x == as.Date(paste0(format(max(x), "%Y-%m"), "-01"))) |> 
    mutate(growth_rate = round((val - lag(val)) / val *100, 2),
           val = format(as.integer(val, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})
# generators
mappers_generators_period_last <- reactive({
  mappers_generators_period() |>
    arrange(desc(x)) |> 
    slice(1) |> 
    mutate(val = format(as.integer(val, 0), nsmall = 1, big.mark = ","))
})
mappers_world_generators_24H <- reactive({
  mappers_generators_period() |> 
    arrange(x) |> 
    slice_tail(n = 2) |> 
    mutate(growth_rate = round((val - lag(val)) / val *100, 2),
           val = format(as.integer(val, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})
mappers_world_generators_month1 <- reactive({
  mappers_generators_period() |> 
    arrange(x) |> 
    filter(x == max(x) | 
             x == as.Date(paste0(format(max(x), "%Y-%m"), "-01"))) |> 
    mutate(growth_rate = round((val - lag(val)) / val *100, 2),
           val = format(as.integer(val, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})
# plants
mappers_plants_period_last <- reactive({
  mappers_plants_period() |>
    arrange(desc(x)) |> 
    slice(1) |> 
    mutate(val = format(as.integer(val, 0), nsmall = 1, big.mark = ","))
})
mappers_world_plants_24H <- reactive({
  mappers_plants_period() |> 
    arrange(x) |> 
    slice_tail(n = 2) |> 
    mutate(growth_rate = round((val - lag(val)) / val *100, 2),
           val = format(as.integer(val, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})
mappers_world_plants_month1 <- reactive({
  mappers_plants_period() |> 
    arrange(x) |> 
    filter(x == max(x) | 
             x == as.Date(paste0(format(max(x), "%Y-%m"), "-01"))) |> 
    mutate(growth_rate = round((val - lag(val)) / val *100, 2),
           val = format(as.integer(val, 0), nsmall = 1, big.mark = ",")) |> 
    fill(everything(), .direction = "downup") |> 
    filter(row_number() == 1)
})

# color_selected_measure <- reactive({
#   switch(input$time_period,
#          "Segments" = "#ecc123",
#          "Substations" = "#54a36a",
#          "generators" = "#6d0f06")
# })
# color_selected_measure_bg <- reactive({
#   switch(input$time_period,
#          "Segments" = "#4f4e4d",
#          "Substations" = "white",
#          "generators" = "white")
# })
```



```{r}
#| label: VB5
value_box(
  id = "card5",
  title = "Mappers for segments",
  theme = value_box_theme(bg = "#f1d365", fg = "#4f4e4d"),
  value = uiOutput("n5_complete"),
  showcase = plotlyOutput("n5_sparkline")
)
```

### Row


```{r}
#| label: VB5.0
value_box(
  id = "card5.0",
  title = "Mappers for circuits relations",
  theme = value_box_theme(bg = "#036d7a", fg = "white"),
  value = uiOutput("n5.0_complete"),
  showcase = plotlyOutput("n5.0_sparkline")
)
```

### Row


```{r}
#| label: VB6
value_box(
  id = "card6",
  title = "Mappers for substations",
  theme = value_box_theme(bg = "#54a36a", fg = "white"),
  value = uiOutput("n6_complete"),
  showcase = plotlyOutput("n6_sparkline")
)
```

### Row


```{r}
#| label: VB7
value_box(
  id = "card7",
  title = "Mappers for generators",
  theme = value_box_theme(bg = "#985750", fg = "white"),
  value = uiOutput("n7_complete"),
  showcase = plotlyOutput("n7_sparkline")
)
```

### Row


```{r}
#| label: VB7.2
value_box(
  id = "card7.2",
  title = "Mappers for plants",
  theme = value_box_theme(bg = "#f19050", fg = "#4f4e4d"),
  value = uiOutput("n7.2_complete"),
  showcase = plotlyOutput("n7.2_sparkline")
)
```

### Row


```{r}
#| context: server
#| label: display 5 valuebox mappers

output$n5_complete <- renderUI({
  
  if (mappers_lines_period_last()$val == "NA") { #on n'affiche rien qd df vide (sinon error affichée)
    "-" } else {
      
  tags$div(tags$div(style = "font-size: 1.2em;", 
                    ifelse(mappers_lines_period_last()$val == "NA", "", mappers_lines_period_last()$val)),
    tags$div(style = "font-size: 0.5em; margin-top: 12px; opacity: 0.9;",
             tags$div(tags$img(src = "images/myg_24h.svg",                                 
                               style = "height: 25px; vertical-align: top; margin-right: 5px;"), 
                      tags$span(style = "font-size: 1.5em;", mappers_world_lines_24H()$val),
                      if(mappers_lines_period_last()$val > mappers_world_lines_24H()$val) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"), 
                                paste0("+", mappers_world_lines_24H()$growth_rate, "%"))
                        } else if(mappers_lines_period_last()$val < mappers_world_lines_24H()$val) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(mappers_world_lines_24H()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #FFA500;", "=") 
                            }),
             tags$div(style = "margin-top: 2px;",
                      tags$img(src = "images/myg_1m.svg",                                 
                               style = "height: 25px; vertical-align: top; margin-right: 5px;"), 
                      tags$span(style = "font-size: 1.5em;", mappers_world_lines_month1()$val),
                      if(mappers_lines_period_last()$val > mappers_world_lines_month1()$val) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"),
                                paste0("+", mappers_world_lines_month1()$growth_rate, "%"))
                        } else if(mappers_lines_period_last()$val < mappers_world_lines_month1()$val) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(mappers_world_lines_month1()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #FFA500;", "=")
                            })))
    }
})
output$n5_sparkline <- renderPlotly({
  plotly_time_series(mappers_lines_period(),
                     x = ~x, y = ~val,
                     my_title = input$nom_pays_mappers)
  })

output$n5.0_complete <- renderUI({
  
  if (nrow(mappers_circuits_period()) == 0) { #on n'affiche rien qd df vide (sinon error affichée)
    "-" } else {
      
  tags$div(tags$div(style = "font-size: 1.2em;", 
                    mappers_circuits_period_last()$val),
    tags$div(style = "font-size: 0.5em; margin-top: 12px; opacity: 0.9;",
             tags$div(tags$img(src = "images/myg_24h.svg",                                 
                               style = "height: 25px; vertical-align: top; margin-right: 5px; filter: brightness(0) invert(1);"), 
                      tags$span(style = "font-size: 1.5em;", mappers_world_circuits_24H()$val),
                      if(mappers_circuits_period_last()$val > mappers_world_circuits_24H()$val) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"), 
                                paste0("+", mappers_world_circuits_24H()$growth_rate, "%"))
                        } else if(mappers_circuits_period_last()$val < mappers_world_circuits_24H()$val) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(mappers_world_circuits_24H()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #f19050;", "=") 
                            }),
             tags$div(style = "margin-top: 2px;",
                      tags$img(src = "images/myg_1m.svg",                                 
                               style = "height: 25px; vertical-align: top; margin-right: 5px; filter: brightness(0) invert(1);"), 
                      tags$span(style = "font-size: 1.5em;", mappers_world_circuits_month1()$val),
                      if(mappers_circuits_period_last()$val > mappers_world_circuits_month1()$val) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"),
                                paste0("+", mappers_world_circuits_month1()$growth_rate, "%"))
                        } else if(mappers_circuits_period_last()$val < mappers_world_circuits_month1()$val) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(mappers_world_circuits_month1()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #f19050;", "=")
                            })))
    }
})
output$n5.0_sparkline <- renderPlotly({
  plotly_time_series(mappers_circuits_period(),
                     x = ~x, y = ~val,
                     my_title = input$nom_pays_mappers)
  })

output$n6_complete <- renderUI({
  
  if (mappers_substations_period_last()$val == "NA") { #on n'affiche rien qd df vide (sinon error affichée)
    "-" } else {
      
  tags$div(tags$div(style = "font-size: 1.2em;", 
                    ifelse(mappers_substations_period_last()$val == "NA", "", mappers_substations_period_last()$val)),
    tags$div(style = "font-size: 0.5em; margin-top: 12px; opacity: 0.9;",
             tags$div(tags$img(src = "images/myg_24h.svg",                                 
                               style = "height: 25px; vertical-align: top; margin-right: 5px; filter: brightness(0) invert(1);"), 
                      tags$span(style = "font-size: 1.5em;", mappers_world_substations_24H()$val),
                      if(mappers_substations_period_last()$val > mappers_world_substations_24H()$val) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"), 
                                paste0("+", mappers_world_substations_24H()$growth_rate, "%"))
                        } else if(mappers_substations_period_last()$val < mappers_world_substations_24H()$val) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(mappers_world_substations_24H()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #FFA500;", "=") 
                            }),
             tags$div(style = "margin-top: 2px;",
                      tags$img(src = "images/myg_1m.svg",                                 
                               style = "height: 25px; vertical-align: top; margin-right: 5px; filter: brightness(0) invert(1);"), 
                      tags$span(style = "font-size: 1.5em;", mappers_world_substations_month1()$val),
                      if(mappers_substations_period_last()$val > mappers_world_substations_month1()$val) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"),
                                paste0("+", mappers_world_substations_month1()$growth_rate, "%"))
                        } else if(mappers_substations_period_last()$val < mappers_world_substations_month1()$val) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(mappers_world_substations_month1()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #FFA500;", "=")
                            })))
    }
})
output$n6_sparkline <- renderPlotly({
  plotly_time_series(mappers_substations_period(),
                     x = ~x, y = ~val,
                     my_title = input$nom_pays_mappers)
  })

output$n7_complete <- renderUI({
  
  if (mappers_generators_period_last()$val == "NA") { #on n'affiche rien qd df vide (sinon error affichée)
    "-" } else {
      
  tags$div(tags$div(style = "font-size: 1.2em;", 
                    ifelse(mappers_generators_period_last()$val == "NA", "", mappers_generators_period_last()$val)),
    tags$div(style = "font-size: 0.5em; margin-top: 12px; opacity: 0.9;",
             tags$div(tags$img(src = "images/myg_24h.svg",                                 
                               style = "height: 25px; vertical-align: top; margin-right: 5px; filter: brightness(0) invert(1);"), 
                      tags$span(style = "font-size: 1.5em;", mappers_world_generators_24H()$val),
                      if(mappers_generators_period_last()$val > mappers_world_generators_24H()$val) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"), 
                                paste0("+", mappers_world_generators_24H()$growth_rate, "%"))
                        } else if(mappers_generators_period_last()$val < mappers_world_generators_24H()$val) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(mappers_world_generators_24H()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #FFA500;", "=") 
                            }),
             tags$div(style = "margin-top: 2px;",
                      tags$img(src = "images/myg_1m.svg",                                 
                               style = "height: 25px; vertical-align: top; margin-right: 5px; filter: brightness(0) invert(1);"), 
                      tags$span(style = "font-size: 1.5em;", mappers_world_generators_month1()$val),
                      if(mappers_generators_period_last()$val > mappers_world_generators_month1()$val) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"),
                                paste0("+", mappers_world_generators_month1()$growth_rate, "%"))
                        } else if(mappers_generators_period_last()$val < mappers_world_generators_month1()$val) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(mappers_world_generators_month1()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #FFA500;", "=")
                            })))
    }
})
output$n7_sparkline <- renderPlotly({
  plotly_time_series(mappers_generators_period(),
                     x = ~x, y = ~val,
                     my_title = input$nom_pays_mappers)
  })

output$n7.2_complete <- renderUI({
  
  if (nrow(mappers_plants_period_last()) == 0) { #on n'affiche rien qd df vide (sinon error affichée)
    "-" } else {
      
  tags$div(tags$div(style = "font-size: 1.2em;", 
                    ifelse(mappers_plants_period_last()$val == "NA", "", mappers_plants_period_last()$val)),
    tags$div(style = "font-size: 0.5em; margin-top: 12px; opacity: 0.9;",
             tags$div(tags$img(src = "images/myg_24h.svg",                                 
                               style = "height: 25px; vertical-align: top; margin-right: 5px;"), 
                      tags$span(style = "font-size: 1.5em;", mappers_world_plants_24H()$val),
                      if(mappers_plants_period_last()$val > mappers_world_plants_24H()$val) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"), 
                                paste0("+", mappers_world_plants_24H()$growth_rate, "%"))
                        } else if(mappers_plants_period_last()$val < mappers_world_plants_24H()$val) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(mappers_world_plants_24H()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #f1d365;", "=") 
                            }),
             tags$div(style = "margin-top: 2px;",
                      tags$img(src = "images/myg_1m.svg",                                 
                               style = "height: 25px; vertical-align: top; margin-right: 5px;"), 
                      tags$span(style = "font-size: 1.5em;", mappers_world_plants_month1()$val),
                      if(mappers_plants_period_last()$val > mappers_world_plants_month1()$val) {
                        tagList(tags$span(style = "color: #90EE90;", "▲"),
                                paste0("+", mappers_world_plants_month1()$growth_rate, "%"))
                        } else if(mappers_plants_period_last()$val < mappers_world_plants_month1()$val) {
                          tagList(tags$span(style = "color: #FC4B3D;", "▼"),
                                  paste0(mappers_world_plants_month1()$growth_rate, "%"))
                          } else {
                            tags$span(style = "color: #f1d365;", "=")
                            })))
    }
})
output$n7.2_sparkline <- renderPlotly({
  plotly_time_series(mappers_plants_period(),
                     x = ~x, y = ~val,
                     my_title = input$nom_pays_mappers)
  })
```


## Column {width="80%"}

### Row 


#### Column {width="60%" .tabset}

##### Segments

```{r}
plotlyOutput('plot7.2')
```

```{r}
#| context: server
#| label: plots segments mappers



# Import selected data
selected_line_data <- reactive({
  switch(input$time_period,
         "Since the beginning of the project" = read_csv("/data/api/mappers_lines_all.csv", show_col_types = FALSE) |> 
                        filter(x == max(x), .by = Pays) |> 
                        rename(val = labels.transmission.amount),
         "Last 30 days" = read_csv("/data/api/mappers_lines_all.csv", show_col_types = FALSE) |> 
                        filter(x == max(x), .by = Pays) |> 
                        rename(val = labels.transmission.amount_30d),
         "Last 24 hours" = read_csv("/data/api/mappers_lines_all.csv", show_col_types = FALSE) |> 
                        filter(x == max(x), .by = Pays) |> 
                        rename(val = labels.transmission.amount_1d) 
         )
})

selected_line_data2 <- reactive({
  selected_line_data() |> 
      distinct(x, val, Pays) |> 
      arrange(desc(val)) |> 
      mutate(index_place = row_number(),
             index_place_name = case_when(index_place == 1 ~ paste0(index_place-1, "st place in the ranking"),
                                          index_place == 2 ~ paste0(index_place-1, "st place in the ranking"),
                                          index_place == 3 ~ paste0(index_place-1, "nd place in the ranking"),
                                          index_place == 4 ~ paste0(index_place-1, "rd place in the ranking"),
                                          !is.na(index_place) ~ paste0(index_place-1, "th place in the ranking"),
                                          .default = as.character(index_place))) |> 
      filter_around_country(input$nom_pays_mappers) |> 
      filter(Pays != "World (default)")
})


# Plot
output$plot7.2 <- renderPlotly({
  
      if (nrow(selected_line_data2()) == 0 | all(is.na(selected_line_data2()$val))) {
    # Créer un plotly vide avec message
    plot_ly() |>
      layout(
        xaxis = list(showgrid = FALSE, showticklabels = FALSE, zeroline = FALSE),
        yaxis = list(showgrid = FALSE, showticklabels = FALSE, zeroline = FALSE),
        annotations = list(
          list(
            text = "No data for this country",
            xref = "paper",
            yref = "paper",
            x = 0.5,
            y = 0.5,
            showarrow = FALSE,
            font = list(size = 16, color = "gray")
          )
        )
      )
  } else {

  # Plot
  graph <- selected_line_data2() |> 
    arrange(index_place) |> 
    mutate(Pays = fct_reorder(Pays, desc(index_place))) |> 
    ggplot() +
    geom_col(aes(x = Pays, y = max(val)), fill = "#F3F3F3", width = .85) +
    geom_col(aes(x = Pays, y = val, alpha = Pays != input$nom_pays_mappers,
                 text = ifelse(val == 1,
                               paste0(val, " mapper\n", index_place_name),
                               paste0(val, " mappers\n", index_place_name))), 
             fill = "#ECC229", width = .85) +
    scale_y_continuous(labels = scales::comma) + 
    scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 20)) + 
    scale_alpha_manual(values = c(.9, .4)) +
    coord_flip() +
    labs(y = "Number of mappers", title = "Countries with the highest \nnumber of mappers") +
    theme_custom() +
    theme(legend.position = "none",
          panel.grid.major.x = ggplot2::element_blank(),
          panel.grid.major.y = ggplot2::element_blank(),
          plot.title.position = "plot",
          axis.title.y = element_blank(),
          axis.text.y = element_text(size = 10))
  ggplotly(graph, tooltip = c("text"))
  }
})
```

##### Circuits relations


```{r}
plotlyOutput('plot8.0.2')
```

```{r}
#| context: server
#| label: plots circuits mappers



# Import selected data
selected_circuits_data <- reactive({
  switch(input$time_period,
         "Since the beginning of the project" = read_csv("/data/api/mappers_circuits_all.csv", show_col_types = FALSE) |> 
                        filter(x == max(x), .by = Pays) |> 
                        rename(val = labels.transmission.amount),
         "Last 30 days" = read_csv("/data/api/mappers_circuits_all.csv", show_col_types = FALSE) |> 
                        filter(x == max(x), .by = Pays) |> 
                        rename(val = labels.transmission.amount_30d),
         "Last 24 hours" = read_csv("/data/api/mappers_circuits_all.csv", show_col_types = FALSE) |> 
                        filter(x == max(x), .by = Pays) |> 
                        rename(val = labels.transmission.amount_1d) 
         )
})

# Filtre sur le top 10 réactif // pays sélectionné
filter_around_country <- function(df, selected_country, n_before = 5, n_after = 5) {
  country_idx <- which(df$Pays == selected_country) # Trouver l'index du pays sélectionné
  if (length(country_idx) == 0) {
    empty_df <- df[0, ] # Créer un dataframe vide avec les mêmes colonnes
    return(empty_df)
  }
  total_rows <- nrow(df)
  total_desired <- n_before + 1 + n_after
  start_idx <- max(1, country_idx - n_before) # Calculer les indices
  end_idx <- min(total_rows, country_idx + n_after)
  if ((end_idx - start_idx + 1) < total_desired && total_rows >= total_desired) { # Ajuster pour avoir 11 lignes si possible
    if (country_idx <= n_before) {
      end_idx <- min(total_rows, start_idx + total_desired - 1)
    } else if (country_idx > total_rows - n_after) {
      start_idx <- max(1, end_idx - total_desired + 1)
    }
  }
  df[start_idx:end_idx, ]
}

# On applique la fonction
selected_circuits_data2 <- reactive({
  selected_circuits_data() |> 
      distinct(x, val, Pays) |> 
      arrange(desc(val)) |> 
      mutate(index_place = row_number(),
             index_place_name = case_when(index_place == 1 ~ paste0(index_place-1, "st place in the ranking"),
                                          index_place == 2 ~ paste0(index_place-1, "st place in the ranking"),
                                          index_place == 3 ~ paste0(index_place-1, "nd place in the ranking"),
                                          index_place == 4 ~ paste0(index_place-1, "rd place in the ranking"),
                                          !is.na(index_place) ~ paste0(index_place-1, "th place in the ranking"),
                                          .default = as.character(index_place))) |> 
      filter_around_country(input$nom_pays_mappers) |> 
      filter(Pays != "World (default)")
})


# Plot
output$plot8.0.2 <- renderPlotly({
  
    if (nrow(selected_circuits_data2()) == 0) {
    # Créer un plotly vide avec message
    plot_ly() |>
      layout(
        xaxis = list(showgrid = FALSE, showticklabels = FALSE, zeroline = FALSE),
        yaxis = list(showgrid = FALSE, showticklabels = FALSE, zeroline = FALSE),
        annotations = list(
          list(
            text = "No data for this country",
            xref = "paper",
            yref = "paper",
            x = 0.5,
            y = 0.5,
            showarrow = FALSE,
            font = list(size = 16, color = "gray")
          )
        )
      )
  } else {

  # Plot
  graph <- selected_circuits_data2() |> 
    arrange(index_place) |> 
    mutate(Pays = fct_reorder(Pays, desc(index_place))) |> 
    ggplot() +
    geom_col(aes(x = Pays, y = max(val)), fill = "#F3F3F3", width = .85) +
    geom_col(aes(x = Pays, y = val, alpha = Pays != input$nom_pays_mappers,
                 text = ifelse(val == 1,
                               paste0(val, " mapper\n", index_place_name),
                               paste0(val, " mappers\n", index_place_name))), 
             fill = "#036D7A", width = .85) +
    scale_y_continuous(labels = scales::comma) + 
    scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 20)) + 
    scale_alpha_manual(values = c(.9, .4)) +
    coord_flip() +
    labs(y = "Number of mappers", title = "Countries with the highest \nnumber of mappers") +
    theme_custom() +
    theme(legend.position = "none",
          panel.grid.major.x = ggplot2::element_blank(),
          panel.grid.major.y = ggplot2::element_blank(),
          plot.title.position = "plot",
          axis.title.y = element_blank(),
          axis.text.y = element_text(size = 10))
  ggplotly(graph, tooltip = c("text"))
  }
})
```




##### Substations


```{r}
plotlyOutput('plot8.2')
```

```{r}
#| context: server
#| label: plots substations mappers



# Import selected data
selected_substation_data <- reactive({
  switch(input$time_period,
         "Since the beginning of the project" = read_csv("/data/api/mappers_substations_all.csv", show_col_types = FALSE) |> 
                        filter(x == max(x), .by = Pays) |> 
                        rename(val = labels.transmission.amount),
         "Last 30 days" = read_csv("/data/api/mappers_substations_all.csv", show_col_types = FALSE) |> 
                        filter(x == max(x), .by = Pays) |> 
                        rename(val = labels.transmission.amount_30d),
         "Last 24 hours" = read_csv("/data/api/mappers_substations_all.csv", show_col_types = FALSE) |> 
                        filter(x == max(x), .by = Pays) |> 
                        rename(val = labels.transmission.amount_1d) 
         )
})

# On applique la fonction
selected_substation_data2 <- reactive({
  selected_substation_data() |> 
      distinct(x, val, Pays) |> 
      arrange(desc(val)) |> 
      mutate(index_place = row_number(),
             index_place_name = case_when(index_place == 1 ~ paste0(index_place-1, "st place in the ranking"),
                                          index_place == 2 ~ paste0(index_place-1, "st place in the ranking"),
                                          index_place == 3 ~ paste0(index_place-1, "nd place in the ranking"),
                                          index_place == 4 ~ paste0(index_place-1, "rd place in the ranking"),
                                          !is.na(index_place) ~ paste0(index_place-1, "th place in the ranking"),
                                          .default = as.character(index_place))) |> 
      filter_around_country(input$nom_pays_mappers) |> 
      filter(Pays != "World (default)")
})


# Plot
output$plot8.2 <- renderPlotly({
  
  if (nrow(selected_substation_data2()) == 0 | all(is.na(selected_substation_data2()$val))) {
    # Créer un plotly vide avec message
    plot_ly() |>
      layout(
        xaxis = list(showgrid = FALSE, showticklabels = FALSE, zeroline = FALSE),
        yaxis = list(showgrid = FALSE, showticklabels = FALSE, zeroline = FALSE),
        annotations = list(
          list(
            text = "No data for this country",
            xref = "paper",
            yref = "paper",
            x = 0.5,
            y = 0.5,
            showarrow = FALSE,
            font = list(size = 16, color = "gray")
          )
        )
      )
  } else {

  # Plot
  graph <- selected_substation_data2() |> 
    arrange(index_place) |> 
    mutate(Pays = fct_reorder(Pays, desc(index_place))) |> 
    ggplot() +
    geom_col(aes(x = Pays, y = max(val)), fill = "#F3F3F3", width = .85) +
    geom_col(aes(x = Pays, y = val, alpha = Pays != input$nom_pays_mappers,
                 text = ifelse(val == 1,
                               paste0(val, " mapper\n", index_place_name),
                               paste0(val, " mappers\n", index_place_name))), 
             fill = "#54a36a", width = .85) +
    scale_y_continuous(labels = scales::comma) + 
    scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 20)) + 
    scale_alpha_manual(values = c(.9, .4)) +
    coord_flip() +
    labs(y = "Number of mappers", title = "Countries with the highest \nnumber of mappers") +
    theme_custom() +
    theme(legend.position = "none",
          panel.grid.major.x = ggplot2::element_blank(),
          panel.grid.major.y = ggplot2::element_blank(),
          plot.title.position = "plot",
          axis.title.y = element_blank(),
          axis.text.y = element_text(size = 10))
  ggplotly(graph, tooltip = c("text"))
  }
})
```

##### Generators




```{r}
plotlyOutput('plot9.2')
```

```{r}
#| context: server
#| label: plots generators mappers



# Import selected data
selected_generator_data <- reactive({
  switch(input$time_period,
         "Since the beginning of the project" = read_csv("/data/api/mappers_generators_all.csv", 
                                                         show_col_types = FALSE) |> 
                        filter(x == max(x), .by = Pays) |> 
                        rename(val = amount),
         "Last 30 days" = read_csv("/data/api/mappers_generators_all.csv", show_col_types = FALSE) |> 
                        filter(x == max(x), .by = Pays) |> 
                        rename(val = amount_30d),
         "Last 24 hours" = read_csv("/data/api/mappers_generators_all.csv", show_col_types = FALSE) |> 
                        filter(x == max(x), .by = Pays) |> 
                        rename(val = amount_1d) 
         )
})

# On applique la fonction
selected_generator_data2 <- reactive({
  selected_generator_data() |> 
      distinct(x, val, Pays) |> 
      arrange(desc(val)) |> 
      mutate(index_place = row_number(),
             index_place_name = case_when(index_place == 1 ~ paste0(index_place-1, "st place in the ranking"),
                                          index_place == 2 ~ paste0(index_place-1, "st place in the ranking"),
                                          index_place == 3 ~ paste0(index_place-1, "nd place in the ranking"),
                                          index_place == 4 ~ paste0(index_place-1, "rd place in the ranking"),
                                          !is.na(index_place) ~ paste0(index_place-1, "th place in the ranking"),
                                          .default = as.character(index_place))) |> 
      filter_around_country(input$nom_pays_mappers) |> 
      filter(Pays != "World (default)")
})

# Plot
output$plot9.2 <- renderPlotly({
  
  if (nrow(selected_generator_data2()) == 0 | all(is.na(selected_generator_data2()$val))) {
    # Créer un plotly vide avec message
    plot_ly() |>
      layout(
        xaxis = list(showgrid = FALSE, showticklabels = FALSE, zeroline = FALSE),
        yaxis = list(showgrid = FALSE, showticklabels = FALSE, zeroline = FALSE),
        annotations = list(
          list(
            text = "No data for this country",
            xref = "paper",
            yref = "paper",
            x = 0.5,
            y = 0.5,
            showarrow = FALSE,
            font = list(size = 16, color = "gray")
          )
        )
      )
  } else {

  # Plot
  graph <- selected_generator_data2() |> 
    arrange(index_place) |> 
    mutate(Pays = fct_reorder(Pays, desc(index_place))) |> 
    ggplot() +
    geom_col(aes(x = Pays, y = max(val)), fill = "#F3F3F3", width = .85) +
    geom_col(aes(x = Pays, y = val, alpha = Pays != input$nom_pays_mappers,
                 text = ifelse(val == 1,
                               paste0(val, " mapper\n", index_place_name),
                               paste0(val, " mappers\n", index_place_name))), 
             fill = "#985750", width = .85) +
    scale_y_continuous(labels = scales::comma) + 
    scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 20)) + 
    scale_alpha_manual(values = c(.9, .4)) +
    coord_flip() +
    labs(y = "Number of mappers", title = "Countries with the highest \nnumber of mappers") +
    theme_custom() +
    theme(legend.position = "none",
          panel.grid.major.x = ggplot2::element_blank(),
          panel.grid.major.y = ggplot2::element_blank(),
          plot.title.position = "plot",
          axis.title.y = element_blank(),
          axis.text.y = element_text(size = 10))
  ggplotly(graph, tooltip = c("text"))
  }
})
```


##### Plants




```{r}
plotlyOutput('plot10.2')
```

```{r}
#| context: server
#| label: plots plants mappers



# Import selected data
selected_plants_data <- reactive({
  switch(input$time_period,
         "Since the beginning of the project" = read_csv("/data/api/mappers_plants_all.csv", 
                                                         show_col_types = FALSE) |> 
                        filter(x == max(x), .by = Pays) |> 
                        rename(val = amount),
         "Last 30 days" = read_csv("/data/api/mappers_plants_all.csv", show_col_types = FALSE) |> 
                        filter(x == max(x), .by = Pays) |> 
                        rename(val = amount_30d),
         "Last 24 hours" = read_csv("/data/api/mappers_plants_all.csv", show_col_types = FALSE) |> 
                        filter(x == max(x), .by = Pays) |> 
                        rename(val = amount_1d) 
         )
})

# On applique la fonction
selected_plants_data2 <- reactive({
  selected_plants_data() |> 
      distinct(x, val, Pays) |> 
      arrange(desc(val)) |> 
      mutate(index_place = row_number(),
             index_place_name = case_when(index_place == 1 ~ paste0(index_place-1, "st place in the ranking"),
                                          index_place == 2 ~ paste0(index_place-1, "st place in the ranking"),
                                          index_place == 3 ~ paste0(index_place-1, "nd place in the ranking"),
                                          index_place == 4 ~ paste0(index_place-1, "rd place in the ranking"),
                                          !is.na(index_place) ~ paste0(index_place-1, "th place in the ranking"),
                                          .default = as.character(index_place))) |> 
      filter_around_country(input$nom_pays_mappers) |> 
      filter(Pays != "World (default)")
})

# Plot
output$plot10.2 <- renderPlotly({
  
  if (nrow(selected_plants_data2()) == 0 | all(is.na(selected_plants_data2()$val))) {
    # Créer un plotly vide avec message
    plot_ly() |>
      layout(
        xaxis = list(showgrid = FALSE, showticklabels = FALSE, zeroline = FALSE),
        yaxis = list(showgrid = FALSE, showticklabels = FALSE, zeroline = FALSE),
        annotations = list(
          list(
            text = "No data for this country",
            xref = "paper",
            yref = "paper",
            x = 0.5,
            y = 0.5,
            showarrow = FALSE,
            font = list(size = 16, color = "gray")
          )
        )
      )
  } else {

  # Plot
  graph <- selected_plants_data2() |> 
    arrange(index_place) |> 
    mutate(Pays = fct_reorder(Pays, desc(index_place))) |> 
    ggplot() +
    geom_col(aes(x = Pays, y = max(val)), fill = "#F3F3F3", width = .85) +
    geom_col(aes(x = Pays, y = val, alpha = Pays != input$nom_pays_mappers,
                 text = ifelse(val == 1,
                               paste0(val, " mapper\n", index_place_name),
                               paste0(val, " mappers\n", index_place_name))), 
             fill = "#f19050", width = .85) +
    scale_y_continuous(labels = scales::comma) + 
    scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 20)) + 
    scale_alpha_manual(values = c(.9, .4)) +
    coord_flip() +
    labs(y = "Number of mappers", title = "Countries with the highest \nnumber of mappers") +
    theme_custom() +
    theme(legend.position = "none",
          panel.grid.major.x = ggplot2::element_blank(),
          panel.grid.major.y = ggplot2::element_blank(),
          plot.title.position = "plot",
          axis.title.y = element_blank(),
          axis.text.y = element_text(size = 10))
  ggplotly(graph, tooltip = c("text"))
  }
})
```


#### Column {width="35%"}


```{r}
#| context: server
#| label: prepare data growth rate mappers

# Préparation des données
  #circuits
circuits1_mappers <-  reactive({
  mappers_circuits() |> 
    mutate(x = as.Date(x)) |> 
    filter(x == "2025-03-01" | x == max(x, na.rm = TRUE)) |> 
    mutate(growth_rate_circuit = (labels.transmission.amount - lag(labels.transmission.amount)) / lag(labels.transmission.amount)) |> 
    select(growth_rate_circuit) |> 
    na.omit()
})
  #line
lines1_mappers <-  reactive({
  mappers_lines() |> 
    mutate(x = as.Date(x)) |> 
    filter(x == "2025-03-01" | x == max(x, na.rm = TRUE)) |> 
    mutate(growth_rate_line = (labels.transmission.amount - lag(labels.transmission.amount)) / lag(labels.transmission.amount)) |> 
    select(growth_rate_line) |> 
    na.omit()
})
    #substations
substations1_mappers <-  reactive({
  mappers_substations() |> 
    mutate(x = as.Date(x)) |> 
    filter(x == "2025-03-01" | x == max(x, na.rm = TRUE)) |> 
    mutate(growth_rate_substation = (labels.transmission.amount - lag(labels.transmission.amount)) / lag(labels.transmission.amount)) |> 
    select(growth_rate_substation) |> 
    na.omit()
})
    # generators
generators1_mappers <-  reactive({
  mappers_generators() |> 
    mutate(x = as.Date(x)) |> 
    filter(x == "2025-03-01" | x == max(x, na.rm = TRUE)) |> 
    mutate(growth_rate_generator = (labels.transmission.amount - lag(labels.transmission.amount)) / lag(labels.transmission.amount)) |> 
    select(growth_rate_generator) |> 
    na.omit()
})
    # plants
plants1_mappers <-  reactive({
  mappers_plants() |> 
    mutate(x = as.Date(x)) |> 
    filter(x == "2025-03-01" | x == max(x, na.rm = TRUE)) |> 
    mutate(growth_rate_plant = (labels.transmission.amount - lag(labels.transmission.amount)) / lag(labels.transmission.amount)) |> 
    select(growth_rate_plant) |> 
    na.omit()
})

dfs_list_mappers <- reactive({
  list(lines1_mappers(), circuits1_mappers(), substations1_mappers(), generators1_mappers(), plants1_mappers())
})
dfs_non_vides_mappers <- reactive({
  Filter(function(x) nrow(x) > 0, dfs_list_mappers())
})

growth_rate_mappers <- reactive({
  bind_cols(dfs_non_vides_mappers()) |> 
    pivot_longer(cols = everything(), values_to = "Valeur", names_to = "Mesure", names_prefix = "growth_rate_") |> 
    mutate(Mesure = str_replace_all(Mesure, c("circuit" = "Circuits relations",
                                              "line" = "Segments",
                                              "substation" = "Substations",
                                              "generator" = "Generators",
                                              "plant" = "Plants")))
})
```

```{r}
#| title: Growth rate since March 2025
plotlyOutput('plot10')
```

```{r}
#| context: server
#| label: growth rate mappers

# Plot line length
output$plot10 <- renderPlotly({
  
      if (nrow(growth_rate_mappers()) == 0) {
    # Créer un plotly vide avec message
    plot_ly() |>
      layout(
        xaxis = list(showgrid = FALSE, showticklabels = FALSE, zeroline = FALSE),
        yaxis = list(showgrid = FALSE, showticklabels = FALSE, zeroline = FALSE),
        annotations = list(
          list(
            text = "No data for this country",
            xref = "paper",
            yref = "paper",
            x = 0.5,
            y = 0.5,
            showarrow = FALSE,
            font = list(size = 16, color = "gray")
          )
        )
      )
  } else {

  #plot depending on selected country
  graph <- growth_rate_mappers() |> 
    mutate(Mesure = factor(Mesure, levels = c("Plants", "Generators", "Substations", "Circuits relations", "Segments"))) |> 
    ggplot() +
    geom_segment(aes(x = 0, xend = Valeur, y = Mesure, yend = Mesure, color = Mesure), linewidth = 1) +
    geom_point(aes(x = Valeur, y = Mesure, color = Mesure,
                   text = paste("+", round(Valeur*100, 2), "%")), size = 4) +
    labs(y = "", x = "Growth rate (%)") +
    scale_color_manual(values = c("Circuits relations" = "#036d7a",
                                  "Segments" = "#ecc123",
                                  "Substations" = "#54a36a",
                                  "Generators" = "#6d0f06",
                                  "Plants" = "#f19050")) +
    scale_x_continuous(labels = scales::percent) +
    scale_y_discrete(labels = function(x) stringr::str_wrap(x, width = 10)) + #axis-text trop longs sur plusieurs lignes
    theme_custom() +
    theme(legend.position = "none", 
          panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
          panel.grid.major.y = ggplot2::element_blank()) 
  #interactive graph
  ggplotly(graph, tooltip = c("text"))
  }
})
```


# Power grid map

```{r}
#| label: import data geojson Colombia

colombia_jan <- st_read("/data/colombia_230_20250101.geojson", quiet = TRUE)
colombia_oct <- st_read("/data/colombia_230_20251013.geojson", quiet = TRUE)
```


```{r}
#| title: Map of power grid of Colombia
#| label: map Colombia

leaflet() |>
  addMapPane("left", zIndex = 0) %>%
  addMapPane("right", zIndex = 0) %>%
  addTiles(group = "base", layerId = "baseid1", options = pathOptions(pane = "right")) |> #"CartoDB.Positron"
  addTiles(group = "base", layerId = "baseid2", options = pathOptions(pane = "left")) |> 
  addPolylines(
    data = colombia_jan,
    color = "#036d7a", weight = 1.2, opacity = 1,
    group = "January 2025", options = leafletOptions(pane = "right")
  ) |>
  addPolylines(
    data = colombia_oct,
    color = "#6d0f06", weight = 1.2, opacity = 1,
    group = "October 2025", options = leafletOptions(pane = "left")
  ) |>
  addLayersControl(overlayGroups = c("January 2025", "October 2025")) |>  
  addSidebyside(
    layerId = "sidecontrols",
    leftId = "baseid1",
    rightId = "baseid2"
  ) |> 
  addLegend(
    position = "topleft",
    colors = "#036d7a",
    labels = "January 2025",
    opacity = 1
  ) |> 
  addLegend(
    position = "topright",
    colors = "#6d0f06",
    labels = "October 2025",
  opacity = 1
  )
```


```{r}
#| eval: false
#| context: server
#| include: false

# Fonction helper pour gérer les paramètres URL
gerer_url <- function() {
  observe({
    # Récupérer la page actuelle 
    page_actuelle <- input$navbar  # ou input de navigation
    pays_selectionne <- input$nom_pays
    
    if (!is.null(pays_selectionne)) {
      # Construire l'URL avec page et pays
      nouveau_hash <- paste0("#", page_actuelle, "?country=", pays_selectionne)
      updateQueryString(nouveau_hash, mode = "replace")
    }
  })
  
  # Restaurer l'état depuis l'URL
  observe({
    hash <- session$clientData$url_hash
    
    if (!is.null(hash) && nchar(hash) > 1) {
      # Enlever le # initial
      hash <- substring(hash, 2)
      
      # Séparer page et pays
      parts <- strsplit(hash, "-")[[1]]
      
      if (length(parts) >= 2) {
        page <- parts[1]
        pays <- paste(parts[-1], collapse = "-")
        
        # Mettre à jour la navigation et la sélection
        # updateNavbarPage(session, "navbar", selected = page)
        if (pays %in% unique(df_line$Pays)) {
          updateSelectInput(session, "nom_pays", selected = pays)
        }
      }
    }
  })
}

# Appeler la fonction
gerer_url()
```

