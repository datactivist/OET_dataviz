---
title: "Progress of the MapYourGrid project"
format: 
  dashboard:
    nav-buttons: [github]
    github: https://github.com/datactivist/OET_dataviz
logo: "https://raw.githubusercontent.com/open-energy-transition/MapYourGrid/main/docs/images/logos/MapYourGrid-logo.png"
theme: [sandstone, custom.scss]
fig-width: 10
fig-asp: 0.3
resources: 
  - "leaflet.providers"
server: shiny
---

```{r}
#| label: chargement des packages et thème graphs
#| context: setup
#| message: false

library(tidyverse)
library(jsonlite)
library(plotly)
library(scales)
library(gt)
library(gtExtras)
library(janitor)
library(sf)
library(leaflet)
library(leafem)
library(leaflet.extras2)
library(shiny)
library(rvest)
library(glue)
library(DT)
library(bslib)
library(bsicons)

#Thème pour les graphiques
theme_custom <- function (){
    ggplot2::theme(plot.title = ggplot2::element_text(size = 21, face = "bold", color = "#222222"), 
        plot.subtitle = ggplot2::element_text(size = 18, face = "italic", margin = ggplot2::margin(0, 0, 9, 0)), 
        plot.caption = ggplot2::element_text(size = 18, margin = ggplot2::margin(9, 0, 9, 0)), 
        plot.title.position = "plot",
        plot.caption.position = "plot",
        legend.title = ggplot2::element_text( size = 18, color = "#222222"), 
        legend.position = "top", 
        legend.text.align = 0, 
        legend.background = ggplot2::element_blank(),
        legend.key = ggplot2::element_blank(),
        legend.text = ggplot2::element_text( size = 18,color = "#222222"), 
        axis.text = ggplot2::element_text( size = 15,color = "#222222"), 
        axis.text.x = ggplot2::element_text(margin = ggplot2::margin(5,b = 10)), 
        axis.title = ggplot2::element_text( size = 18,color = "#222222"),
        axis.ticks = ggplot2::element_blank(),
        axis.line = ggplot2::element_blank(), 
        panel.grid.minor = ggplot2::element_blank(),
        panel.grid.major.y = ggplot2::element_line(color = "#cbcbcb"),
        panel.grid.major.x = ggplot2::element_blank(), 
        panel.background = ggplot2::element_blank(),
        strip.background = ggplot2::element_rect(fill = "white"),
        strip.text = ggplot2::element_text(size = 22, hjust = 0, face = "bold"),
        text = element_text(family = "Open Sans"))
}
```

```{r}
#| label: import data world to get last update
last_date <- fromJSON("https://mapyourgrid.infos-reseaux.com/projects/2025-01_lines/counts")$data |> 
  arrange(t) |> 
  slice_tail(n = 1)
```

# {.sidebar}


The data displayed on this dashboard was last updated on **`r format(as.Date(last_date$t, format = "%Y-%m-%dT%H:%M:%S"),"%b %d, %Y")`**.

------------------------------------------------------------------------


Select a country to view its indicators. By default, **global indicators** are shown.

```{r}
#| label: scraping table wiki relations / pays

df_line <- read_csv("../data/api/data_line_all.csv")

# Bouton de sélection du pays
selectInput('nom_pays', 'Country', unique(df_line$Pays), selected = "World (default)")
```



# Indicators

```{r}
#| context: server
#| label: get data and stats from selected country

# Line
value_world_line <- reactive({
  df_line <- read_csv("../data/api/data_line_all.csv")
  df_line |> 
    filter(Pays == input$nom_pays)
})
  #length
value_world_line_last <- reactive({
  value_world_line() |> 
    arrange(t) |> 
    slice_tail(n = 1) |> 
    mutate(length = ifelse(length > 1000000000,
                           paste(format(round(as.numeric(length) / 1e6, 0), trim = TRUE), "M"),
                           format(as.integer(length, 0), nsmall = 1, big.mark = ",")))
})
  #sections
value_world_sections_last <- reactive({
  value_world_line() |> 
    arrange(t) |> 
    slice_tail(n = 1) |> 
    mutate(amount = ifelse(amount > 1000000000,
                           paste(format(round(as.numeric(amount) / 1e6, 0), trim = TRUE), "M"),
                           format(as.integer(amount, 0), nsmall = 1, big.mark = ",")))
})
# Substations
value_world_substations <- reactive({
  df_substations <- read_csv("../data/api/data_substations_all.csv")
  df_substations |> 
    filter(Pays == input$nom_pays)
})
value_world_substations_last <- reactive({
  value_world_substations() |> 
    arrange(t) |> 
    slice_tail(n = 1) |> 
    mutate(amount = ifelse(amount > 1000000000,
                           paste(format(round(as.numeric(amount) / 1e6, 0), trim = TRUE), "M"),
                           format(as.integer(amount, 0), nsmall = 1, big.mark = ",")))
})
# Pylons (supports)
value_world_supports <- reactive({
  df_supports <- read_csv("../data/api/data_supports_all.csv")
  df_supports |> 
    filter(Pays == input$nom_pays)
})
value_world_supports_last <- reactive({
  value_world_supports() |> 
    arrange(t) |> 
    slice_tail(n = 1) |> 
    mutate(amount = ifelse(amount > 1000000000,
                           paste(format(round(as.numeric(amount) / 1e6, 0), trim = TRUE), "M"),
                           format(as.integer(amount, 0), nsmall = 1, big.mark = ",")))
})
```


## Row {height="20%"}


```{r}
value_box(
  id = "card1",
  title = "Line lenght (km)",
  theme = value_box_theme(bg = "#4e98a1", fg = "white"),
  value = textOutput("n1")
)
```

```{r}
value_box(
  id = "card2",
  title = "Number of sections",
  theme = value_box_theme(bg = "#f1d365", fg = "#4f4e4d"),
  value = textOutput("n2")
)
```

```{r}
value_box(
  id = "card3",
  title = "Number of substations",
  theme = value_box_theme(bg = "#4ea181", fg = "white"),
  value = textOutput("n3")
)
```

```{r}
value_box(
  id = "card4",
  title = "Number of pylons",
  theme = value_box_theme(bg = "#985750", fg = "white"),
  value = textOutput("n4")
)
```

```{r}
#| context: server

output$n1 <- renderText({
  value_world_line_last()$length
})
output$n2 <- renderText({
  value_world_sections_last()$amount
})
output$n3 <- renderText({
  value_world_substations_last()$amount
})
output$n4 <- renderText({
  value_world_supports_last()$amount
})
```


## Row {height="60%"}

### Column {width="30%" .tabset}


```{r}
#| title: Line length

graph <- world_line |> 
  mutate(t = as.Date(t),
         length = length / 100000) |> 
  ggplot() +
  geom_line(aes(x = t, y = length, group = 1,
                text = paste0("Time : ", t, "\nLine lenght : ", format(as.integer(length, 0), nsmall = 1, big.mark = ","), "M km")),
            color = "#036D7A", size = .7) +
  geom_point(aes(x = t, y = length, group = 1,
                text = paste0("Time : ", t, "\nLine lenght : ", format(as.integer(length, 0), nsmall = 1, big.mark = ","), "M km")),
            color = "#036D7A", size = 1) +
  geom_vline(xintercept = as.Date("2025-03-01"), linetype = 2, color = "red4") +
  scale_y_continuous(labels = scales::comma) +
  scale_x_date(date_labels = "%m-%y", breaks = pretty_breaks(n = 10)) +
  labs(x = "Time", 
       y = "Line lenght (M km)") +
  theme_custom() +
  theme(axis.ticks.x = element_line(color = "#cbcbcb"),
        panel.grid.major.x = ggplot2::element_line(color = "#cbcbcb"),
        panel.grid.minor.x = ggplot2::element_line(color = "#cbcbcb"))
viz <- ggplotly(graph, tooltip = c("text")) |> 
  layout(annotations = list(list(x = as.numeric(as.Date("2025-03-10")),
                                 y = max(as.numeric(world_line$length)/100000, na.rm = TRUE),
                                 text = "Start of the MYG<br>project",   
                                 xref = "x", yref = "y", showarrow = FALSE,
                                 font = list(color = "#8B0000"),
                                 align = "left", xanchor = "left", yanchor = "top")))
viz
```


## Row {height="20%"}

```{r}
tableOutput('data')
```

```{r}
#| context: server
 

output$data <- renderTable({
  value_world_line_last()
})

```

